# Миграции ch-sa

Начиная с версии `clickhouse-sqlalchemy 0.1.10` поддерживает **alembic**. Эта поддержка позволяет автоматически создавать миграции из исходного кода с некоторыми ограничениями. Это главное преимущество по сравнению с другими инструментами миграции, когда вам нужно написать простые миграции самостоятельно.

{% hint style="info" %}
Стоит отметить, что в **ClickHouse** нет транзакций. Поэтому миграция не будет откатываться после какой-либо команды с ошибкой. И схема останется в частично перенесенном состоянии.
{% endhint %}

Автогенерация **будет обнаружена** при:

* Добавлении и удалении таблиц и материализованных представлений.
* Добавлении и удалении столбцов.
* Добавлении и удалении комментариев к столбцам и таблицам.

Пример проекта с миграциями [https://github.com/xzkostyan/clickhouse-sqlalchemy-alembic-example.](https://github.com/xzkostyan/clickhouse-sqlalchemy-alembic-example.)

## Требования

Минимальные версии:

* ClickHouse server 21.11.11.1
* clickhouse-sqlalchemy 0.1.10
* alembic 1.5.x

Вы всегда можете написать свои миграции с помощью `op.execute` чистого alembic, если автогенерация невозможна для ваших объектов схемы или вы используете `clickhouse-sqlalchemy < 0.1.10`.

## Ограничения

Общие ограничения:

* Движки не добавляются в `op.create_table`.
* Генерация столбцов `Nullable(T)` через `Column(..., nullable=True)` не поддерживается.

В настоящее время `ATTACH MATERIALIZED VIEW` с измененным оператором **SELECT** не работает для движка **Atomic**.

## Настройка миграции

Вы можете и должны настроить миграции после автогенерации.

Следующие параметры могут быть указаны для:

* `op.detach_mat_view`: `if_exists`, `on_cluster`, `permanently`.
* `op.attach_mat_view`: `if_not_exists`, `on_cluster`.
* `op.create_mat_view`: `if_not_exists`, `on_cluster`, `populate`.

См. документацию ClickHouse по материализованному представлению.

Для `op.add_column` вы можете добавить:

* `AFTER name_after`: `op.add_column(..., sa.Column(..., clickhouse_after=sa.text('my_column')))`.
