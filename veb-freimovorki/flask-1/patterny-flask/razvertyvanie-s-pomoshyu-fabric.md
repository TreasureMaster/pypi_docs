# Развертывание с помощью Fabric

[Fabric](https://www.fabfile.org/) - это инструмент для Python, похожий на **Makefiles**, но с возможностью выполнять команды на удаленном сервере. В сочетании с правильно настроенным пакетом Python ([большие приложения](bolshie-prilozheniya-flask.md)) и хорошей концепцией конфигураций ([обработка конфигурации](../rukovodstvo-polzovatelya-flask/obrabotka-konfiguracii-flask.md)) очень легко развертывать приложения **Flask** на внешних серверах.

Прежде чем мы начнем, вот краткий контрольный список того, что мы должны сделать заранее:

* `Fabric 1.0` необходимо установить локально. В этом руководстве предполагается, что последняя версия **Fabric**.
* Приложение уже должно быть пакетом и требует рабочего файла `setup.py` ([развертывание с помощью Setuptools](razvertyvanie-s-pomoshyu-setuptools.md)).
* В следующем примере мы используем **mod\_wsgi** для удаленных серверов. Вы, конечно, можете использовать там свой любимый сервер, но для этого примера мы выбрали `Apache + mod_wsgi`, потому что он очень прост в настройке и позволяет легко перезагружать приложения без корневого доступа.

## Создание первого Fabfile

**Fabfile** - это то, что контролирует то, что выполняет **Fabric**. Он называется `fabfile.py` и запускается командой **fab**. Все функции, определенные в этом файле, будут отображаться как подкоманды **fab**. Они выполняются на одном или нескольких хостах. Эти хосты могут быть определены либо в **fabfile**, либо в командной строке. В данном случае мы добавим их в файл **fabfile**.

Это базовый первый пример, в котором есть возможность загрузить текущий исходный код на сервер и установить его в уже существующую виртуальную среду:

```python
from fabric.api import *

# пользователь для использования удаленных команд
env.user = 'appuser'
# серверы, на которых выполняются команды
env.hosts = ['server1.example.com', 'server2.example.com']

def pack():
    # сборка пакета
    local('python setup.py sdist --formats=gztar', capture=False)

def deploy():
    # выяснить название пакета и версию
    dist = local('python setup.py --fullname', capture=True).strip()
    filename = '%s.tar.gz' % dist

    # загрузить пакет во временную папку на сервере
    put('dist/%s' % filename, '/tmp/%s' % filename)

    # установить пакет в virtualenv приложения с помощью pip
    run('/var/www/yourapplication/env/bin/pip install /tmp/%s' % filename)

    # удалить загруженный пакет
    run('rm -r /tmp/%s' % filename)

    # touch .wsgi файл, чтобы запустить перезагрузку в mod_wsgi
    run('touch /var/www/yourapplication.wsgi')
```

## Запуск Fabfiles

Как теперь запустить этот **fabfile**? Вы используете команду **fab**. Чтобы развернуть текущую версию кода на удаленном сервере, вы должны использовать эту команду:

```bash
$ fab pack deploy
```

Однако для этого требуется, чтобы на нашем сервере уже была создана папка `/var/www/yourapplication` и `/var/www/yourapplication/env` была виртуальной средой. Кроме того, мы не создаем файл конфигурации или `.wsgi` на сервере. Итак, как мы загрузим новый сервер в нашу инфраструктуру?

Теперь это зависит от количества серверов, которые мы хотим настроить. Если у нас есть только один сервер приложений (который будет у большинства приложений), создание команды в **fabfile** для этого будет излишним. Но очевидно, что вы можете это сделать. В этом случае вы, вероятно, назвали бы это **setup** или **bootstrap**, а затем явно передали бы имя сервера в командной строке:

```bash
$ fab -H newserver.example.com bootstrap
```

Чтобы настроить новый сервер, вы примерно выполните следующие действия:

* Создайте структуру каталогов в `/var/www`:

```bash
$ mkdir /var/www/yourapplication
$ cd /var/www/yourapplication
$ virtualenv --distribute env
```

* Загрузите новый файл `application.wsgi` на сервер и файл конфигурации для приложения (например, `application.cfg`)
* Создайте новую конфигурацию **Apache** для вашего приложения и активируйте ее. Обязательно активируйте отслеживание изменений файла `.wsgi`, чтобы мы могли автоматически перезагрузить приложение, применяя команду **touch**. (См. [mod\_wsgi (Apache)](../rukovodstvo-polzovatelya-flask/flask-i-varianty-razvertyvaniya/mod\_wsgi-apache.md) для получения дополнительной информации)

Итак, теперь вопрос в том, откуда берутся файлы `application.wsgi` и `application.cfg`?

## Файл WSGI

Файл **WSGI** должен импортировать приложение, а также установить переменную среды, чтобы приложение знало, где искать конфигурацию. Это короткий пример, который делает именно это:

```python
import os
os.environ['YOURAPPLICATION_CONFIG'] = '/var/www/yourapplication/application.cfg'
from yourapplication import app
```

Затем само приложение должно инициализироваться следующим образом, чтобы искать конфигурацию в этой переменной среды:

```python
app = Flask(__name__)
app.config.from_object('yourapplication.default_config')
app.config.from_envvar('YOURAPPLICATION_CONFIG')
```

Этот подход подробно объясняется в разделе документации, посвященном [обработке конфигурации](../rukovodstvo-polzovatelya-flask/obrabotka-konfiguracii-flask.md).

## Файл конфигурации

Теперь, как упоминалось выше, приложение найдет правильный файл конфигурации, просмотрев переменную среды **YOURAPPLICATION\_CONFIG**. Поэтому мы должны поместить конфигурацию в место, где приложение сможет ее найти. Файлы конфигурации имеют неприятное качество, поскольку они различны на всех компьютерах, поэтому вы обычно не редактируете их.

Популярный подход - хранить файлы конфигурации для разных серверов в отдельном репозитории контроля версий и проверять их на всех серверах. Затем создайте символическую ссылку на файл, который активен для сервера, в место, где он ожидается (например: `/var/www/yourapplication`).

В любом случае, в нашем случае здесь мы ожидаем только один или два сервера, и мы можем загрузить их заранее вручную.

## Первое развертывание

Теперь мы можем выполнить наше первое развертывание. Мы настроили серверы так, чтобы у них были свои виртуальные среды, и активировали конфигурации **apache**. Теперь мы можем упаковать приложение и развернуть его:

```bash
$ fab pack deploy
```

Теперь **Fabric** подключится ко всем серверам и выполнит команды, записанные в **fabfile**. Сначала он выполнит **pack**, чтобы у нас был готов наш архив, а затем он выполнит **deploy**, загрузит исходный код на все серверы и установит его там. Благодаря файлу `setup.py` мы автоматически подключим необходимые библиотеки в нашу виртуальную среду.

## Следующие шаги

С этого момента можно многое сделать, чтобы сделать развертывание действительно интересным:

* Создайте команду **bootstrap**, которая инициализирует новые серверы. Он может инициализировать новую виртуальную среду, соответствующим образом настроить **apache** и т. д.
* Поместите файлы конфигурации в отдельный репозиторий системы управления версиями и создайте символическую ссылку на активные конфигурации.
* Вы также можете поместить код своего приложения в репозиторий и проверить последнюю версию на сервере, а затем установить. Таким образом, вы также можете легко вернуться к более старым версиям.
* подключите функции тестирования, чтобы вы могли развернуть их на внешний сервер и запустить набор тестов.

Работать с **Fabric** - это весело, и вы заметите, что довольно волшебно набрать `fab deploy` и увидеть, как ваше приложение автоматически развертывается на одном или нескольких удаленных серверах.
