# Развертывание с помощью setuptools

[Setuptools](https://pypi.org/project/setuptools/) - это библиотека расширений, которая обычно используется для распространения библиотек и расширений Python. Она расширяет **distutils**, базовую систему установки модулей, поставляемую с Python, чтобы также поддерживать различные более сложные конструкции, которые упрощают распространение больших приложений:

* **поддержка зависимостей:** библиотека или приложение могут объявлять список других библиотек, в зависимости от того, какие из них будут автоматически установлены для вас.
* **реестр пакетов:** setuptools регистрирует ваш пакет вместе с установкой Python. Это позволяет запрашивать информацию, предоставленную одним пакетом, из другого пакета. Наиболее известной особенностью этой системы является поддержка точки входа, которая позволяет одному пакету объявлять «точку входа», к которой другой пакет может подключиться, чтобы расширить другой пакет.
* **менеджер установки:** pip может установить за вас другие библиотеки.

Если у вас установлен Python 2 (`>=2.7.9`) или Python 3 (`>=3.4`) с **python.org**, в вашей системе уже будут **pip** и **setuptools**. В противном случае вам нужно будет установить их самостоятельно.

Сам **Flask** и все библиотеки, которые вы можете найти в PyPI, распространяются либо с **setuptools**, либо с **distutils**.

В этом случае мы предполагаем, что ваше приложение называется `yourapplication.py`, и вы используете не модуль, а пакет. Если вы еще не преобразовали свое приложение в пакет, перейдите к шаблону «[Большие приложения](bolshie-prilozheniya-flask.md)», чтобы узнать, как это можно сделать.

Рабочее развертывание с помощью **setuptools** - это первый шаг к более сложным и автоматизированным сценариям развертывания. Если вы хотите полностью автоматизировать процесс, прочтите также главу «[Развертывание с помощью Fabric](razvertyvanie-s-pomoshyu-fabric.md)».

## Сценарий базовой настройки

Поскольку у вас установлен **Flask**, в вашей системе доступны инструменты установки. **Flask** уже зависит от **setuptools**.

Применяется стандартный отказ от ответственности: [вам лучше использовать virtualenv](https://click.palletsprojects.com/en/7.x/quickstart/#virtualenv).

Ваш установочный код всегда находится в файле с именем `setup.py` рядом с вашим приложением. Имя файла является условным, но поскольку все будут искать файл с таким именем, вам лучше не менять его.

Базовый файл `setup.py` для приложения **Flask** выглядит так:

```python
from setuptools import setup

setup(
    name='Your Application',
    version='1.0',
    long_description=__doc__,
    packages=['yourapplication'],
    include_package_data=True,
    zip_safe=False,
    install_requires=['Flask']
)
```

Помните, что вы должны явно указывать подпакеты. Если вы хотите, чтобы **setuptools** автоматически выполнял поиск пакетов, вы можете использовать функцию **find\_packages**:

```python
from setuptools import setup, find_packages

setup(
    ...
    packages=find_packages()
)
```

Большинство параметров функции настройки должны быть понятными, **include\_package\_data** и **zip\_safe** могут отсутствовать. **include\_package\_data** сообщает **setuptools**, что нужно искать файл `MANIFEST.in` и устанавливать все записи, соответствующие данным пакета. Мы будем использовать это для распространения статических файлов и шаблонов вместе с модулем Python (см. [Распространение ресурсов](razvertyvanie-s-pomoshyu-setuptools.md#rasprostranenie-resursov)). Флаг **zip\_safe** можно использовать для принуждения или предотвращения создания zip-архива. В общем, вы, вероятно, не хотите, чтобы ваши пакеты устанавливались в виде zip-файлов, потому что некоторые инструменты не поддерживают их, и они значительно усложняют отладку.

## Пометка сборок

Полезно различать сборки выпуска и разработки. Добавьте файл `setup.cfg` для настройки этих параметров.

```bash
[egg_info]
tag_build = .dev
tag_date = 1

[aliases]
release = egg_info -Db ''
```

Запуск `python setup.py sdist` создаст пакет разработки с «`.dev`» и добавленной текущей датой: flaskr-1.0.dev20160314.tar.gz. Запуск `python setup.py release sdist` создаст пакет выпуска только с версией: flaskr-1.0.tar.gz.

## Распространение ресурсов

Если вы попытаетесь установить только что созданный пакет, вы заметите, что такие папки, как **static** или **templates**, не установлены для вас. Причина этого в том, что **setuptools** не знает, какие файлы добавить за вас. Что вам нужно сделать, так это создать файл `MANIFEST.in` рядом с файлом `setup.py`. В этом файле перечислены все файлы, которые следует добавить в ваш архив:

```bash
recursive-include yourapplication/templates *
recursive-include yourapplication/static *
```

Не забывайте, что даже если вы зарегистрируете их в файле `MANIFEST.in`, они не будут установлены для вас, если вы не установите для параметра **include\_package\_data** функции **setup** значение `True`!

## Объявление зависимостей

Зависимости объявляются в параметре **install\_requires** в виде списка. Каждый элемент в этом списке - это имя пакета, который следует извлечь из **PyPI** при установке. По умолчанию он всегда будет использовать самую последнюю версию, но вы также можете указать минимальные и максимальные требования к версии. Вот несколько примеров:

```bash
install_requires=[
    'Flask>=0.2',
    'SQLAlchemy>=0.6',
    'BrokenPackage>=0.7,<=1.0'
]
```

Как упоминалось ранее, зависимости извлекаются из **PyPI**. Что, если вы хотите зависеть от пакета, который не может быть найден в **PyPI**, и не будет, потому что это внутренний пакет, которым вы не хотите никому делиться? Просто сделайте это так, как если бы была запись **PyPI**, и предоставьте список альтернативных мест, где **setuptools** должны искать архивы:

```bash
dependency_links=['http://example.com/yourfiles']
```

Убедитесь, что на странице есть список каталогов, а ссылки на странице указывают на настоящие архивы с их правильными именами файлов, поскольку именно так **setuptools** найдет файлы. Если у вас есть внутренний сервер компании, содержащий пакеты, укажите URL-адрес этого сервера.

## Установка/Разработка

Чтобы установить приложение (в идеале в виртуальную среду), просто запустите сценарий `setup.py` с параметром **install**. Он установит ваше приложение в папку `site-packages` **virtualenv**, а также загрузит и установит все зависимости:

```bash
$ python setup.py install
```

Если вы разрабатываете пакет и хотите, чтобы требования **requirements** были установлены, вы можете вместо этого использовать команду **develop**:

```bash
$ python setup.py develop
```

Это имеет то преимущество, что вместо копирования данных просто устанавливается ссылка на папку `site-packges`. После этого вы можете продолжить работу над кодом, не выполняя повторный **install** после каждого изменения.
