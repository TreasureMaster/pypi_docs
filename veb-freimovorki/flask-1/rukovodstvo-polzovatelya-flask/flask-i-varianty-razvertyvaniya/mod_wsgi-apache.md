# mod\_wsgi (Apache)

Если вы используете веб-сервер [Apache](https://httpd.apache.org/), рассмотрите возможность использования [mod\_wsgi](https://github.com/GrahamDumpleton/mod\_wsgi).

{% hint style="info" %}
**Осторожно:**

Заранее убедитесь, что любые вызовы **app.run ()**, которые могут быть в вашем файле приложения, находятся внутри блока `if __name__ == '__main__':` или перемещены в отдельный файл. Просто убедитесь, что он не вызывается, потому что при этом всегда будет запускаться локальный сервер **WSGI**, который нам не нужен, если мы развернем это приложение на **mod\_wsgi**.
{% endhint %}

## Установка mod\_wsgi

Если у вас еще не установлен **mod\_wsgi**, вам нужно либо установить его с помощью диспетчера пакетов, либо скомпилировать его самостоятельно. [Инструкции по установке](https://modwsgi.readthedocs.io/en/develop/installation.html) **mod\_wsgi** охватывают установку исходного кода в системах UNIX.

Если вы используете Ubuntu / Debian, вы можете использовать **apt-get** и активировать его следующим образом:

```bash
$ apt-get install libapache2-mod-wsgi-py3
```

Если вы используете дистрибутив на основе **yum** (Fedora, OpenSUSE и т. д.), вы можете установить его следующим образом:

```bash
$ yum install mod_wsgi
```

В FreeBSD установите **mod\_wsgi**, скомпилировав порт `www/mod_wsgi` или используя **pkg\_add**:

```bash
$ pkg install ap24-py37-mod_wsgi
```

Если вы используете **pkgsrc**, то вы можете установить **mod\_wsgi**, скомпилировав пакет `www/ap2-wsgi`.

Если вы столкнетесь с дочерними процессами с нарушением целостности после первой перезагрузки **apache**, вы можете игнорировать их. Просто перезапустите сервер.

## Создание файла .wsgi

Для запуска вашего приложения вам понадобится файл `yourapplication.wsgi`. Этот файл содержит код, который **mod\_wsgi** выполняет при запуске для получения объекта приложения. Затем объект с именем **application** в этом файле используется как приложение.

Для большинства приложений будет достаточно следующего файла:

```python
from yourapplication import app as application
```

Если фабричная функция используется в файле `__init__.py`, то функцию следует импортировать:

```python
from yourapplication import create_app
application = create_app()
```

Если у вас нет фабричной функции для создания приложения, а есть одноэлементный экземпляр, вы можете напрямую импортировать его как **application**.

Сохраните этот файл где-нибудь, чтобы найти его снова (например: `/var/www/yourapplication`), и убедитесь, что **yourapplication** и все используемые библиотеки находятся на пути загрузки python. Если вы не хотите устанавливать его в масштабе всей системы, подумайте об использовании виртуального экземпляра Python. Имейте в виду, что вам также придется установить свое приложение в **virtualenv**. В качестве альтернативы есть возможность просто исправить путь в файле `.wsgi` перед импортом:

```python
import sys
sys.path.insert(0, '/path/to/the/application')
```

## Конфигурирование Apache

Последнее, что вам нужно сделать, это создать файл конфигурации **Apache** для вашего приложения. В этом примере мы говорим **mod\_wsgi** запустить приложение под другим пользователем по соображениям безопасности:

```markup
<VirtualHost *>
    ServerName example.com

    WSGIDaemonProcess yourapplication user=user1 group=group1 threads=5
    WSGIScriptAlias / /var/www/yourapplication/yourapplication.wsgi

    <Directory /var/www/yourapplication>
        WSGIProcessGroup yourapplication
        WSGIApplicationGroup %{GLOBAL}
        Order deny,allow
        Allow from all
    </Directory>
</VirtualHost>
```

Примечание. **WSGIDaemonProcess** не реализован в Windows, и **Apache** откажется работать с указанной выше конфигурацией. В системе Windows удалите эти строки:

```markup
<VirtualHost *>
    ServerName example.com
    WSGIScriptAlias / C:\yourdir\yourapp.wsgi
    <Directory C:\yourdir>
        Order deny,allow
        Allow from all
    </Directory>
</VirtualHost>
```

Примечание. В конфигурацию управления доступом для [Apache 2.4](https://httpd.apache.org/docs/trunk/upgrading.html) были внесены некоторые изменения.

В частности, синтаксис для разрешений каталога изменился с **httpd 2.2**.

```bash
Order allow,deny
Allow from all
```

на синтаксис **httpd 2.4**

```bash
Require all granted
```

Для получения дополнительной информации обратитесь к [документации mod\_wsgi](https://modwsgi.readthedocs.io/en/develop/index.html).

## Исправление проблем

Если ваше приложение не запускается, следуйте этому руководству по устранению неполадок:

* **Проблема**: приложение не запускается, журнал ошибок показывает, что **SystemExit** игнорируется - У вас есть вызов `app.run ()` в файле приложения, который не защищен условием `if name == 'main':`. Либо удалите этот вызов [run ()](../../api-dokumentaciya-flask/obekt-prilozheniya-flask.md#run) из файла и переместите его в отдельный файл `run.py`, либо поместите в такой блок **if**.
* **Проблема**: приложение выдает ошибки разрешения - Вероятно, это вызвано тем, что ваше приложение запущено не тем пользователем. Убедитесь, что для папок, к которым приложению требуется доступ, установлены соответствующие права и приложение работает от имени правильного пользователя (параметр **user** и **group** в директиве **WSGIDaemonProcess**).
* **Проблема**: приложение умирает с ошибкой при печати - Имейте в виду, что **mod\_wsgi** запрещает что-либо делать с [sys.stdout](https://docs.python.org/3/library/sys.html#sys.stdout) и [sys.stderr](https://docs.python.org/3/library/sys.html#sys.stderr). Вы можете отключить эту защиту из конфигурации, переключив **WSGIRestrictStdout** в off:

```bash
WSGIRestrictStdout Off
```

В качестве альтернативы вы также можете заменить стандартный выход в файле `.wsgi` другим потоком:

```python
import sys
sys.stdout = sys.stderr
```

* **Проблема**: доступ к ресурсам дает ошибки ввода-вывода - Ваше приложение, вероятно, представляет собой единственный файл `.py`, который вы связали символической ссылкой в папку **site-packages**. Имейте в виду, что это не работает, вместо этого вам нужно либо поместить папку в путь Python, в котором хранится файл, либо преобразовать свое приложение в пакет. Причина этого в том, что для неустановленных пакетов имя файла модуля используется для поиска ресурсов, а для символических ссылок выбирается неправильное имя файла.

## Поддержка автоматической перезагрузки

Чтобы помочь инструментам развертывания, вы можете активировать поддержку автоматической перезагрузки. Каждый раз, когда что-то изменяет файл `.wsgi`, **mod\_wsgi** перезагружает для нас все процессы демона.

Для этого просто добавьте следующую директиву в раздел **Directory**:

```bash
WSGIScriptReloading On
```

## Работа с виртуальными окружениями

Преимущество виртуальных сред состоит в том, что они никогда не устанавливают требуемые зависимости в масштабе всей системы, поэтому вы можете лучше контролировать, что и где используется. Если вы хотите использовать виртуальную среду с **mod\_wsgi**, вам нужно немного изменить ваш файл `.wsgi`.

Добавьте следующие строки в начало вашего файла `.wsgi`:

```bash
activate_this = '/path/to/env/bin/activate_this.py'
execfile(activate_this, dict(__file__=activate_this))
```

Для Python 3 добавьте следующие строки в начало вашего файла `.wsgi`:

```bash
activate_this = '/path/to/env/bin/activate_this.py'
with open(activate_this) as file_:
    exec(file_.read(), dict(__file__=activate_this))
```

Это устанавливает пути загрузки в соответствии с настройками виртуальной среды. Помните, что путь должен быть абсолютным.
