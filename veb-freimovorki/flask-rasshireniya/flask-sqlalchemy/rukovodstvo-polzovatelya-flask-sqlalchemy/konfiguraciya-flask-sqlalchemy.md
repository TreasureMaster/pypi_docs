# Конфигурация Flask-SQLAlchemy

Для **Flask-SQLAlchemy** существуют следующие значения конфигурации. **Flask-SQLAlchemy** загружает эти значения из вашей основной конфигурации **Flask**, которые можно заполнить различными способами. Обратите внимание, что некоторые из них нельзя изменить после создания движка **engine**, поэтому обязательно настройте их как можно раньше и не изменяйте их во время выполнения.

### Ключи конфигурации

Список ключей конфигурации, которые в настоящее время понимает расширение:

| Ключ                                 | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **SQLALCHEMY\_DATABASE\_URI**        | <p>URI базы данных, который следует использовать для подключения. Примеры:</p><ul><li><code>sqlite:////tmp/test.db</code></li><li><code>mysql://username:password@server/db</code></li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **SQLALCHEMY\_BINDS**                | Словарь, который сопоставляет ключи привязки с URI соединения SQLAlchemy. Дополнительные сведения о привязках см. в разделе [Несколько баз данных с привязками](neskolko-baz-dannykh-s-privyazkami.md).                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **SQLALCHEMY\_ECHO**                 | Если установлено значение `True`, SQLAlchemy будет регистрировать все операторы, отправленные в **stderr**, что может быть полезно для отладки.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **SQLALCHEMY\_RECORD\_QUERIES**      | Может использоваться для явного отключения или включения записи запросов. Запись запроса происходит автоматически в режиме отладки или тестирования. См. <mark style="color:red;">get\_debug\_queries()</mark> для получения дополнительной информации.                                                                                                                                                                                                                                                                                                                                                                                                                |
| **SQLALCHEMY\_NATIVE\_UNICODE**      | <p>Может использоваться для явного отключения встроенной поддержки Unicode. Это требуется для некоторых адаптеров баз данных (например, PostgreSQL в некоторых версиях Ubuntu) при использовании с неправильными настройками базы данных по умолчанию, которые указывают базы данных без кодирования.</p><p><mark style="color:orange;">Устарело</mark> с версии 2.4 и будет удалено в версии 3.0.</p>                                                                                                                                                                                                                                                                 |
| **SQLALCHEMY\_POOL\_SIZE**           | <p>Размер пула базы данных. По умолчанию используется значение по умолчанию для движка (обычно 5).</p><p><mark style="color:orange;">Устарело</mark> с версии 2.4 и будет удалено в версии 3.0.</p>                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **SQLALCHEMY\_POOL\_TIMEOUT**        | <p>Указывает время ожидания соединения в секундах для пула.</p><p><mark style="color:orange;">Устарело</mark> с версии 2.4 и будет удалено в версии 3.0.</p>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **SQLALCHEMY\_POOL\_RECYCLE**        | <p>Количество секунд, по истечении которых соединение автоматически перезапускается. Это необходимо для MySQL, который по умолчанию удаляет соединения после 8 часов простоя. Обратите внимание, что <strong>Flask-SQLAlchemy</strong> автоматически устанавливает это значение равным 2 часам, если используется MySQL. Некоторые серверные части могут использовать другое значение времени ожидания по умолчанию. Дополнительные сведения о тайм-аутах см. в разделе <a href="https://flask-sqlalchemy.palletsprojects.com/en/2.x/config/#timeouts">Тайм-ауты</a>.</p><p><mark style="color:orange;">Устарело</mark> с версии 2.4 и будет удалено в версии 3.0.</p> |
| **SQLALCHEMY\_MAX\_OVERFLOW**        | <p>Управляет количеством подключений, которые могут быть созданы после достижения пулом максимального размера. Когда эти дополнительные подключения возвращаются в пул, они отключаются и отбрасываются.</p><p><mark style="color:orange;">Устарело</mark> с версии 2.4 и будет удалено в версии 3.0.</p>                                                                                                                                                                                                                                                                                                                                                              |
| **SQLALCHEMY\_TRACK\_MODIFICATIONS** | Если установлено значение `True`, **Flask-SQLAlchemy** будет отслеживать модификации объектов и выдавать сигналы. Значение по умолчанию — `None`, которое включает отслеживание, но выдает предупреждение о том, что в будущем оно будет отключено по умолчанию. Это требует дополнительной памяти и должно быть отключено, если не требуется.                                                                                                                                                                                                                                                                                                                         |
| **SQLALCHEMY\_ENGINE\_OPTIONS**      | Словарь ключевых слов для отправки в [create\_engine()](https://docs.sqlalchemy.org/en/14/core/engines.html#sqlalchemy.create\_engine). См. также **engine\_options** для <mark style="color:red;">SQLAlchemy</mark>.                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

_Новое в версии 0.8_: добавлены ключи конфигурации `SQLALCHEMY_NATIVE_UNICODE`, `SQLALCHEMY_POOL_SIZE`, `SQLALCHEMY_POOL_TIMEOUT` и `SQLALCHEMY_POOL_RECYCLE`.

_Новое в версии 0.12_: Добавлен ключ конфигурации `SQLALCHEMY_BINDS`.

_Новое в версии 0.17_: добавлен ключ конфигурации `SQLALCHEMY_MAX_OVERFLOW`.

_Новое в версии 2.0_: добавлен ключ конфигурации `SQLALCHEMY_TRACK_MODIFICATIONS`.

_Изменено в версии 2.1_: `SQLALCHEMY_TRACK_MODIFICATIONS` будет предупреждать, если не установлено.

_Изменено в версии 2.4_: \* Добавлен ключ конфигурации `SQLALCHEMY_ENGINE_OPTIONS`. \* Устаревшие ключи:

* `SQLALCHEMY_NATIVE_UNICODE`
* `SQLALCHEMY_POOL_SIZE`
* `SQLALCHEMY_POOL_TIMEOUT`
* `SQLALCHEMY_POOL_RECYCLE`
* `SQLALCHEMY_MAX_OVERFLOW`

_Изменено в версии 2.4.3_: `SQLALCHEMY_COMMIT_ON_TEARDOWN` устарел.

### Формат URI подключения

Полный список URI подключения см. в документации SQLAlchemy в разделе ([Поддерживаемые базы данных](https://docs.sqlalchemy.org/en/latest/core/engines.html)). Здесь показаны некоторые общие строки подключения.

SQLAlchemy указывает источник механизма в виде URI в сочетании с необязательными аргументами ключевого слова для указания параметров механизма. Форма URI:

```python
dialect+driver://username:password@host:port/database
```

Многие части строки являются необязательными. Если драйвер не указан, выбирается драйвер по умолчанию (в этом случае убедитесь, что `+` не указан).

Postgres:

```python
postgresql://scott:tiger@localhost/mydatabase
```

MySQL:

```python
mysql://scott:tiger@localhost/mydatabase
```

Oracle:

```python
oracle://scott:tiger@127.0.0.1:1521/sidname
```

SQLite (обратите внимание, что применяются соглашения о пути к платформе):

```python
# Unix/Mac (обратите внимание на четыре начальных косых черты)
sqlite:////absolute/path/to/foo.db
# Windows (обратите внимание на 3 начальных косых черты
# и экранирования обратной косой черты)
sqlite:///C:\\absolute\\path\\to\\foo.db
# Windows (альтернатива с использованием необработанной строки)
r'sqlite:///C:\absolute\path\to\foo.db'
```

### Использование пользовательских метаданных и соглашений об именах

При желании вы можете создать <mark style="color:red;">объект SQLAlchemy</mark> с помощью настраиваемого объекта [MetaData](https://docs.sqlalchemy.org/en/14/core/metadata.html#sqlalchemy.schema.MetaData). Это позволяет вам, среди прочего, указать [пользовательское соглашение об именах ограничений](https://docs.sqlalchemy.org/en/latest/core/constraints.html#constraint-naming-conventions) в сочетании с SQLAlchemy 0.9.2 или выше. Это важно для работы с миграциями базы данных (например, с использованием [alembic](https://alembic.sqlalchemy.org/en/latest/), как указано [здесь](https://alembic.sqlalchemy.org/en/latest/naming.html). Вот пример, предложенный документацией SQLAlchemy:

```python
from sqlalchemy import MetaData
from flask import Flask
from flask_sqlalchemy import SQLAlchemy

convention = {
    "ix": 'ix_%(column_0_label)s',
    "uq": "uq_%(table_name)s_%(column_0_name)s",
    "ck": "ck_%(table_name)s_%(constraint_name)s",
    "fk": "fk_%(table_name)s_%(column_0_name)s_%(referred_table_name)s",
    "pk": "pk_%(table_name)s"
}

metadata = MetaData(naming_convention=convention)
db = SQLAlchemy(app, metadata=metadata)
```

Для получения дополнительной информации о [MetaData](https://docs.sqlalchemy.org/en/14/core/metadata.html#sqlalchemy.schema.MetaData) ознакомьтесь с [официальной документацией по ним](https://docs.sqlalchemy.org/en/latest/core/metadata.html).

### Тайм-ауты

Некоторые серверные части базы данных могут налагать разные тайм-ауты неактивных соединений, что мешает пулу соединений **Flask-SQLAlchemy**.

По умолчанию **MariaDB** настроен на тайм-аут 600 секунд. Это часто трудно отлаживать, исключения только для производственной среды, такие как `2013: Lost connection to MySQL server during query`.

Если вы используете серверную часть (или предварительно настроенную базу данных как услугу) с более низким временем ожидания соединения, рекомендуется установить для `SQLALCHEMY_POOL_RECYCLE` значение, меньшее, чем время ожидания вашей серверной части.
