# Flask-Migrate

**Flask-Migrate** — это расширение, которое обрабатывает миграцию базы данных SQLAlchemy для приложений **Flask** с помощью **Alembic**. Операции с базой данных доступны через интерфейс командной строки **Flask**.

### Зачем использовать Flask-Migrate вместо Alembic напрямую?

**Flask-Migrate** — это расширение, которое правильно настраивает **Alembic** для работы с вашим приложением **Flask** и **Flask-SQLAlchemy**. Что касается фактической миграции базы данных, **Alembic** выполняет все операции, поэтому вы получаете точно такую же функциональность.

### Установка

Установите **Flask-Migrate** с помощью **pip**:

```bash
pip install Flask-Migrate
```

### Пример

Это пример приложения, которое обрабатывает миграцию базы данных через **Flask-Migrate**:

```python
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///app.db'

db = SQLAlchemy(app)
migrate = Migrate(app, db)

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(128))
```

С помощью вышеуказанного приложения вы можете создать репозиторий миграции с помощью следующей команды:

```bash
$ flask db init
```

Это добавит папку _**migrations**_ в ваше приложение. Содержимое этой папки необходимо добавить в систему контроля версий вместе с другими вашими исходными файлами.

Затем вы можете создать первоначальную миграцию:

```bash
$ flask db migrate -m "Initial migration."
```

Сценарий переноса необходимо проверить и отредактировать, так как в настоящее время **Alembic** не обнаруживает каждое изменение, которое вы вносите в свои модели. В частности, в настоящее время **Alembic** не может обнаруживать изменения имени таблицы, изменения имени столбца или ограничения с анонимными именами. Подробное описание ограничений можно найти в [документации по автогенерации Alembic](http://alembic.zzzcomputing.com/en/latest/autogenerate.html#what-does-autogenerate-detect-and-what-does-it-not-detect). После завершения сценарий миграции также необходимо добавить в систему контроля версий.

Затем вы можете применить миграцию к базе данных:

```bash
$ flask db upgrade
```

Затем каждый раз при изменении моделей баз данных повторяйте команды **migrate** и **upgrade**.

Чтобы синхронизировать базу данных в другой системе, просто обновите папку _**migrations**_ из системы управления версиями и выполните команду **upgrade**.

Чтобы просмотреть все доступные команды, выполните следующую команду:

```bash
$ flask db --help
```

Обратите внимание, что сценарий приложения должен быть установлен в переменной среды **FLASK\_APP**, чтобы все вышеперечисленные команды работали, как того требует сценарий командной строки **flask**.

### Обратные вызовы конфигурации

Иногда приложениям необходимо динамически вставлять свои настройки в конфигурацию **Alembic**. Функция, декорированная обратным вызовом **configure**, будет вызываться после чтения конфигурации и до ее использования. Функция может изменить объект конфигурации или заменить его другим.

```python
@migrate.configure
def configure_alembic(config):
    # изменить объект конфигурации
    return config
```

Несколько обратных вызовов конфигурации можно определить, просто декорировав несколько функций. _**Порядок, в котором вызываются несколько обратных вызовов, не определен.**_

### Поддержка нескольких баз данных

**Flask-Migrate** может интегрироваться с функцией [binds](http://flask-sqlalchemy.pocoo.org/binds/) **Flask-SQLAlchemy**, что позволяет отслеживать миграции в несколько баз данных, связанных с приложением.

Чтобы создать репозиторий миграции с несколькими базами данных, добавьте в команду инициализации аргумент `--multidb` :

```bash
$ flask db init --multidb
```

С помощью этой команды репозиторий миграции будет настроен для отслеживания миграции в вашей основной базе данных и в любых дополнительных базах данных, определенных в параметре конфигурации **SQLALCHEMY\_BINDS**.

### Справочник по командам

### Справочник API
