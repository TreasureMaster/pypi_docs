# Описание Flask-Caching

Flask-Caching - это расширение Flask, которое добавляет поддержку кеширования для различных бэкэндов в любое приложение Flask. Помимо обеспечения поддержки всех исходных серверных модулей кеширования werkzeug через унифицированный API, также можно разработать свой собственный серверный модуль кеширования, создав подкласс класса flask\_caching.backends.base.BaseCache.

## Поддержка версий

Начиная с версии 1.8, Flask-Caching поддерживает только Python 3.5+.

## Установка

Установите расширение с помощью следующей команды:

```bash
$ pip install Flask-Caching
```

## Настройка

Управление кешем осуществляется через экземпляр Cache:

```python
from flask import Flask
from flask_caching import Cache

config = {
    "DEBUG": True,                  # некоторые специфические конфигурации Flask
    "CACHE_TYPE": "SimpleCache",    # Конфиги, связанные с Flask-Caching
    "CACHE_DEFAULT_TIMEOUT": 300
}
app = Flask(__name__)
# скажите Flask использовать указанную выше конфигурацию
app.config.from_mapping(config)
cache = Cache(app)
```

Вы также можете настроить свой экземпляр Cache позже во время настройки, используя метод init\_app:

```python
cache = Cache(config={'CACHE_TYPE': 'SimpleCache'})

app = Flask(__name__)
cache.init_app(app)
```

Вы также можете предоставить альтернативный словарь конфигурации, который будет полезен, если будет несколько экземпляров Cache, каждый с другим сервером:

```python
#: Метод A: во время создания экземпляра класса
cache = Cache(config={'CACHE_TYPE': 'SimpleCache'})
#: Метод B: во время вызова init_app
cache.init_app(app, config={'CACHE_TYPE': 'SimpleCache'})
```

_Новое в версии 0.7_.

## Кэширование функций просмотра

Для кеширования функций просмотра вы будете использовать декоратор cached (). Этот декоратор будет использовать request.path по умолчанию для cache\_key:

```python
@app.route("/")
@cache.cached(timeout=50)
def index():
    return render_template('index.html')
```

У кэшированного декоратора есть еще один необязательный аргумент, который называется **unless**. Этот аргумент принимает вызываемый объект, который возвращает `True` или `False`. Если **unless** возвращает `True`, он полностью обойдет механизм кеширования.

{% hint style="danger" %}
При использовании **cached** в представлении позаботьтесь о том, чтобы поместить его между декоратором Flask **@route** и определением вашей функции. Пример:

```python
@app.route('/')
@cache.cached(timeout=50)
def index():
    return 'Cached for 50s'
```

Если вы поменяете оба декоратора, то, что будет кэшировано, будет результатом декоратора **@route**, а не результатом вашей функции просмотра.
{% endhint %}

## Кеширование других функций

Используя тот же декоратор **@cached**, вы можете кэшировать результат других функций, не связанных с просмотром. Единственное условие - вы замените **key\_prefix**, иначе будет использоваться cache\_key request.path. Ключи управляют тем, что следует извлекать из кеша. Если, например, ключ не существует в кэше, в кэше будет создана новая запись «ключ-значение». В противном случае будет возвращено значение (т.е. кешированный результат) ключа:

```python
@cache.cached(timeout=50, key_prefix='all_comments')
def get_all_comments():
    comments = do_serious_dbio()
    return [x.author for x in comments]

cached_comments = get_all_comments()
```

## Мемоизация

Смотри memoize ().

В мемоизации аргументы функций также включаются в cache\_key.

{% hint style="info" %}
Для функций, не получающих аргументов, **cached ()** и **memoize ()** фактически одинаковы.
{% endhint %}

Memoize также предназначен для методов, поскольку он будет учитывать идентичность. аргумента «self» или «cls» как часть ключа кеширования.

Теория мемоизации заключается в том, что если у вас есть функция, которую нужно вызвать несколько раз в одном запросе, она будет вычисляться только при первом вызове функции с этими аргументами. Например, объект sqlalchemy, который определяет, есть ли у пользователя роль. Возможно, вам придется вызывать эту функцию много раз в течение одного запроса. Чтобы избежать обращения к базе данных каждый раз, когда потребуется эта информация, вы можете сделать что-то вроде следующего:

```python
class Person(db.Model):
    @cache.memoize(50)
    def has_membership(self, role_id):
        return Group.query.filter_by(user=self, role_id=role_id).count() >= 1
```

{% hint style="danger" %}
Использование изменяемых объектов (классов и т. д.) как части ключа кеширования может стать сложной задачей. Предлагается не передавать экземпляр объекта в мемоизированную функцию. Тем не менее, memoize выполняет **repr ()** для переданных аргументов, поэтому, если у объекта есть функция **\_\_repr\_\_**, которая возвращает уникально идентифицирующую строку для этого объекта, она будет использоваться как часть ключа кеша.

Например, объект sqlalchemy person, который возвращает идентификатор базы данных как часть уникального идентификатора:

```python
class Person(db.Model):
    def __repr__(self):
        return "%s(%s)" % (self.__class__.__name__, self.id)
```
{% endhint %}

## Удаление кеша Memoize

_Новое в версии 0.2_.

Возможно, вам потребуется удалить кеш для каждой функции. Используя приведенный выше пример, допустим, вы меняете разрешения пользователя и назначаете их роли, но теперь вам нужно пересчитать, есть ли у них определенное членство или нет. Вы можете сделать это с помощью функции **delete\_memoized ()**:

```python
cache.delete_memoized(user_has_membership)
```

{% hint style="info" %}
Если в качестве параметра указано только имя функции, все ее мемоизированные версии будут признаны недействительными. Однако вы можете удалить определенный кеш, указав те же значения параметров, что и при кэшировании. В следующем примере удаляется только кеш роли пользователя:

```python
user_has_membership('demo', 'admin')
user_has_membership('demo', 'user')

cache.delete_memoized(user_has_membership, 'demo', 'user')
```
{% endhint %}

{% hint style="danger" %}
Если метод класса мемоизирован, вы должны указать класс в качестве первого аргумента \*args.

```python
class Foobar(object):
    @classmethod
    @cache.memoize(5)
    def big_foo(cls, a, b):
        return a + b + random.randrange(0, 100000)

cache.delete_memoized(Foobar.big_foo, Foobar, 5, 2)
```
{% endhint %}

## Кеширование фрагментов Jinja2

Использование:

```python
{% raw %}
{% cache [timeout [,[key1, [key2, ...]]]] %}
...
{% endcache %}
{% endraw %}
```

По умолчанию в качестве ключа кеша используется значение «path to template file» + «block start line». Также имя ключа можно задать вручную. Ключи объединяются в одну строку, что позволяет избежать вычисления одного и того же блока в разных шаблонах.

Установите для тайм-аута значение `None`, чтобы не было тайм-аута, но с настраиваемыми ключами:

```python
{% raw %}
{% cache None, "key" %}
...
{% endcache %}
{% endraw %}
```

Установите таймаут на **del**, чтобы удалить кешированное значение:

```python
{% raw %}
{% cache 'del', key1 %}
...
{% endcache %}
{% endraw %}
```

Если ключи предоставлены, вы можете легко сгенерировать ключ фрагмента шаблона и удалить его вне контекста шаблона:

```python
from flask_caching import make_template_fragment_key
key = make_template_fragment_key("key1", vary_on=["key2", "key3"])
cache.delete(key)
```

Учитывая, что у нас есть макросы **render\_form\_field** и **render\_submit**:

```python
{% raw %}
{% cache 60*5 %}
<div>
    <form>
    {% render_form_field(form.username) %}
    {% render_submit() %}
    </form>
</div>
{% endcache %}
{% endraw %}
```

## Очистка кеша

Смотри **clear ()**.

Вот пример скрипта для очистки кеша вашего приложения:

```python
from flask_caching import Cache

from yourapp import app, your_cache_config

cache = Cache()


def main():
    cache.init_app(app, config=your_cache_config)

    with app.app_context():
        cache.clear()

if __name__ == '__main__':
    main()
```

{% hint style="danger" %}
Некоторые реализации серверной части не поддерживают полную очистку кеша. Кроме того, если вы не используете префикс ключа, некоторые реализации (например, Redis) будут очищать всю базу данных. Убедитесь, что в базе данных кеширования не хранятся другие данные.
{% endhint %}

## Явное кэширование данных

Данные можно кэшировать явно с помощью прокси-методов, таких как **Cache.set ()** и **Cache.get ()** напрямую. Есть много других методов прокси, доступных через класс **Cache**.

Например:

```python
@app.route("/html")
@app.route("/html/<foo>")
def html(foo=None):
    if foo is not None:
        cache.set("foo", foo)
    bar = cache.get("foo")
    return render_template_string(
        "<html><body>foo cache: {{bar}}</body></html>", bar=bar
    )
```

## Конфигурирование Flask-Caching

Для Flask-Caching существуют следующие значения конфигурации:

| Настройка                           | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ----------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|  **CACHE\_TYPE**                    | <p>Указывает, какой тип объекта кэширования использовать. Это строка импорта, которая будет импортирована и создана. Предполагается, что объект импорта - это функция, которая будет возвращать объект кеша, соответствующий API кеша.</p><p>Для объектов flask_caching.backends.cache необязательно указывать всю строку импорта, только одно из следующих имен.</p><p>Типы встроенного кеша:</p><ul><li><strong>NullCache</strong> (по умолчанию; старое имя <strong>null</strong>)</li><li><strong>SimpleCache</strong> (старое название <strong>simple</strong>)</li><li><strong>FileSystemCache</strong> (старое название - <strong>filesystem</strong>)</li><li><strong>RedisCache</strong> (требуется redis; старое имя - <strong>redis</strong>)</li><li><strong>RedisSentinelCache</strong> (требуется redis, старое имя - <strong>redissentinel</strong>)</li><li><strong>RedisClusterCache</strong> (требуется redis и rediscluster; старое имя - <strong>rediscluster</strong>)</li><li><strong>UWSGICache</strong> (требуется uwsgi; старое имя - <strong>uwsgi</strong>)</li><li><strong>MemcachedCache</strong> (требуется pylibmc или memcache; старое имя - <strong>memcached</strong> или <strong>gaememcached</strong>)</li><li><strong>SASLMemcachedCache</strong> (требуется pylibmc; старое имя - <strong>saslmemcached</strong>)</li><li><strong>SpreadSASLMemcachedCache</strong> (требуется pylibmc; старое имя - <strong>spreadsaslmemcached</strong>)</li></ul> |
|  **CACHE\_NO\_NULL\_WARNING**       | Отключает предупреждающее сообщение при использовании типа кэша «null».                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|  **CACHE\_ARGS**                    | Необязательный список для распаковки и передачи во время создания экземпляра класса кеша.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|  **CACHE\_OPTIONS**                 | Необязательный словарь для передачи во время создания экземпляра класса кеша.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|  **CACHE\_DEFAULT\_TIMEOUT**        | Тайм-аут по умолчанию, который используется, если тайм-аут не указан. Единица времени - секунды.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|  **CACHE\_IGNORE\_ERRORS**          | Если установка означает, что любые ошибки, возникшие в процессе удаления, будут игнорироваться. Однако, если для него установлено значение `«False»`, он остановится при первой ошибке. Эта опция актуальна только для **filesystem** серверной части и **simple**. По умолчанию `False`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|  **CACHE\_THRESHOLD**               | Максимальное количество элементов, которые будет хранить кеш, прежде чем он начнет удалять некоторые из них. Используется только для **SimpleCache** и **FileSystemCache**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|  **CACHE\_KEY\_PREFIX**             | Префикс, добавляемый перед всеми ключами. Это позволяет использовать один и тот же сервер **memcached** для разных приложений. Используется только для **RedisCache** и **MemcachedCache**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|  **CACHE\_SOURCE\_CHECK**           | Условие по умолчанию, применяемое к декораторам функций, которое определяет, должен ли исходный код функции быть включен при формировании хэша, который используется в качестве ключа кеша. Это гарантирует, что в случае изменения исходного кода кэшированное значение не будет возвращено при вызове новой функции, даже если аргументы совпадают. По умолчанию `False`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|  **CACHE\_UWSGI\_NAME**             | Имя экземпляра кеширования **uwsgi**, к которому необходимо подключиться, например: **mycache@localhost:3031**, по умолчанию - пустая строка, что означает, что **uWSGI** будет кэшировать в локальном экземпляре. Если кеш находится в том же экземпляре, что и приложение **werkzeug**, вам нужно только указать имя кеша.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|  **CACHE\_MEMCACHED\_SERVERS**      | Список или кортеж адресов серверов. Используется только для **MemcachedCache**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|  **CACHE\_MEMCACHED\_USERNAME**     | Имя пользователя для аутентификации **SASL** с **memcached**. Используется только для **SASLMemcachedCache**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|  **CACHE\_MEMCACHED\_PASSWORD**     | Пароль для аутентификации **SASL** с **memcached**. Используется только для **SASLMemcachedCache**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|  **CACHE\_REDIS\_HOST**             | Хост сервера **Redis**. Используется только для **RedisCache**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|  **CACHE\_REDIS\_PORT**             | Порт сервера **Redis**. По умолчанию **6379**. Используется только для **RedisCache**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|  **CACHE\_REDIS\_PASSWORD**         | Пароль **Redis** для сервера. Используется только для **RedisCache** и **RedisSentinelCache**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|  **CACHE\_REDIS\_DB**               | **Redis db** (числовой индекс с отсчетом от нуля). По умолчанию **0**. Используется только для **RedisCache** и **RedisSentinelCache**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|  **CACHE\_REDIS\_SENTINELS**        | Список или кортеж дозорных адресов **Redis**. Используется только для **RedisSentinelCache**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|  **CACHE\_REDIS\_SENTINEL\_MASTER** | Имя главного сервера в конфигурации дозорного. Используется только для **RedisSentinelCache**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|  **CACHE\_REDIS\_CLUSTER**          | Строка адресов узлов кластера **Redis**, разделенных запятыми. Например, **host1:port1,host2:port2,host3:port3**. Используется только для **RedisClusterCache**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|  **CACHE\_DIR**                     | Каталог для хранения кеша. Используется только для **FileSystemCache**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|  **CACHE\_REDIS\_URL**              | URL-адрес для подключения к серверу **Redis**. Пример **redis://user:password@localhost:6379/2**. Поддерживает протоколы **redis://**, **rediss://** (redis через TLS) и **unix://**. См. Дополнительную информацию о поддержке URL \[здесь] ([http://redis-py.readthedocs.io/en/latest/index.html#redis.ConnectionPool.from\_url](http://redis-py.readthedocs.io/en/latest/index.html#redis.ConnectionPool.from\_url)). Используется только для **RedisCache**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |

## Встроенные серверные части кеша

### NullCache
