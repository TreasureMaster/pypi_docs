# Точки входа

## Точки входа (Entry Points)

Пакеты могут содержать команды для запуска на консоли (сценарии консоли), например команду `pip`. Эти команды определены для пакета как особый тип точки входа в `setup.cfg` или `setup.py`.

### Консольные скрипты

Сначала рассмотрим пример без точек входа. Представьте пакет, определенный таким образом:

```bash
timmins/
    timmins/__init__.py
    timmins/__main__.py
    setup.cfg # или setup.py
    # другие необходимые файлы
```

с `__init__.py` таким, как:

```python
def hello_world():
    print("Hello world")
```

и `__main__.py`, обеспечивающим хук:

```python
from . import hello_world
if __name__ == '__main__':
    hello_world()
```

После установки пакета функцию можно вызвать через модуль **runpy**:

```bash
python -m timmins
```

Добавление точки входа в консольный скрипт позволяет пакету определять удобное имя для выполнения установщиками пакета. Установщики, такие как **pip**, создают сценарии оболочки для выполнения функции. В приведенном выше примере, чтобы создать команду `hello-world`, которая вызывает `timmins.hello_world`, добавьте точку входа консольного скрипта в `setup.cfg`:

```bash
[options.entry_points]
console_scripts =
    hello-world = timmins:hello_world
```

После установки пакета пользователь может вызвать эту функцию, просто вызвав `hello-world` в командной строке.

Синтаксис точек входа определяется следующим образом:

где _**name**_ - это имя скрипта, который вы хотите создать, левая часть `:` - это модуль, содержащий вашу функцию, а правая часть - это объект, который вы хотите вызвать (например, функция).

В дополнение к `console_scripts`, **setuptools** поддерживает `gui_scripts`, которые запускают приложение с графическим интерфейсом пользователя без запуска в окне терминала.

### Рекламное поведение

Сценарии консоли - это одно из применений более общей концепции точек входа. Точки входа в более общем случае позволяют упаковщику рекламировать поведение для обнаружения другими библиотеками и приложениями. Эта функция обеспечивает функциональность, подобную «плагину», когда одна библиотека запрашивает точки входа, а любое количество других библиотек предоставляет эти точки входа.

Хороший пример поведения этого подключаемого модуля можно увидеть в [подключаемых модулях **pytest**](https://docs.pytest.org/en/latest/writing\_plugins.html), где **pytest** - это тестовая среда, которая позволяет другим библиотекам расширять или изменять его функциональность через точку входа `pytest11`.

Сценарии консоли работают аналогично, когда библиотеки рекламируют свои команды и инструменты, подобно тому, как **pip** создает сценарии оболочки, которые вызывают эти команды.

Для проекта, желающего запрашивать точки входа, **setuptools** рекомендует модуль [importlib.metadata](https://docs.python.org/3/library/importlib.metadata.html) (часть **stdlib** начиная с Python 3.8) или его резервный порт, [importlib\_metadata](https://pypi.org/project/importlib-metadata/).

Например, чтобы найти точки входа в консольный скрипт из приведенного выше примера:

```python
>>> from importlib import metadata
>>> eps = metadata.entry_points()['console_scripts']
```

_**eps**_ теперь представляет собой список объектов **EntryPoint**, один из которых соответствует определенному выше `hello-world = timmins: hello_world`. Каждая **EntryPoint** содержит `name`, `group` и `value`. Он также предоставляет метод `.load ()` для импорта и загрузки этой точки входа (модуля или объекта).

```bash
[options.entry_points]
my.plugins =
    hello-world = timmins:hello_world
```

Затем другой проект, желающий загрузить плагины `'my.plugins'`, может запустить следующую процедуру для загрузки (и вызова) таких плагинов:

```python
>>> from importlib import metadata
>>> eps = metadata.entry_points()['my.plugins']
>>> for ep in eps:
...     plugin = ep.load()
...     plugin()
```

Проект, запрашивающий точки входа, не должен иметь никаких зависимостей или предварительных знаний о библиотеках, реализующих точки входа, а последующие пользователи могут создавать функциональные возможности, собирая вместе библиотеки, реализующие точки входа.

### Управление зависимостями

Для правильной работы некоторых точек входа могут потребоваться дополнительные зависимости. Для такой точки входа объявите в квадратных скобках любое количество дополнительных зависимостей после определения точки входа. Такие точки входа будут жизнеспособными только в том случае, если их дополнительные функции были заявлены и установлены. См. [руководство по управлению зависимостями](upravlenie-zavisimostyami-v-setuptools.md) для получения дополнительной информации об определении дополнительных требований. Рассмотрим приведенный выше пример:

```bash
[options.entry_points]
console_scripts =
    hello-world = timmins:hello_world [pretty-printer]
```

В этом случае сценарий `hello-world` жизнеспособен только в том случае, если указан дополнительный параметр `pretty-printer`, и поэтому хост плагина может исключить эту точку входа (то есть не устанавливать скрипт консоли), если соответствующие дополнительные зависимости не установлены.
