# Базовое использование tox

## Простая tox.ini / среда по умолчанию

Поместите основную информацию о своем проекте и тестовых средах, в которых вы хотите запустить свой проект, в файл `tox.ini`, который должен находиться рядом с вашим файлом `setup.py`:

```bash
# содержание: tox.ini , поместить в тот же каталог, что и setup.py
[tox]
envlist = py27,py36
[testenv]
# установить фреймворк тестирования
# ... или установите что-нибудь еще, что вам может понадобиться здесь
deps = pytest
# запустить тесты
# ... или запустите любой другой инструмент командной строки,
# который вам нужно запустить здесь
commands = pytest
```

Чтобы **sdist-package,** установите и протестируйте свой проект, теперь вы можете ввести в командной строке:

```bash
tox
```

Это упакует ваш текущий проект **sdist**, создаст две среды **virtualenv**, установит пакет **sdist** в среды и запустит указанную команду в каждой из них. С участием:

```bash
tox -e py36
```

вы можете ограничить тестовый запуск средой `python3.6`.

**Tox** в настоящее время понимает следующие шаблоны:

```bash
py: Текущая версия Python tox использует
pypy: Любой доступный PyPy
jython: Любой доступный Jython
pyN: Python версии N., например py2 или py3 ... и т. д.
pyNM: Python версии N.M., например py27 или py38 ... и т. д.
pypyN: PyPy версии N., например pypy2 или pypy3 ... и т. д.
pypyNM: PyPy версии N.M., например pypy27 или pypy35 ... и т. д.
```

Однако вы также можете создать свои собственные имена тестовой среды, некоторые примеры см. в [примерах](./).

## pyproject.toml tox унаследованный ini

Конфигурация **tox** также может быть в `pyproject.toml` (если вы хотите избежать лишнего файла).

В настоящее время через **legacy\_tox\_ini** поддерживается только старый формат, однако планируется его собственная реализация.

```bash
[build-system]
requires = [ "setuptools >= 35.0.2", "wheel >= 0.29.0"]
build-backend = "setuptools.build_meta"

[tool.tox]
legacy_tox_ini = """
[tox]
envlist = py27,py36

[testenv]
deps = pytest >= 3.0.0, <4
commands = pytest
"""
```

Обратите внимание: когда вы определяете `pyproject.toml`, вы должны определить раздел **build-system** для PEP-518.

## Указание платформы

_Новое в версии 2.0_.

Если вы хотите указать, на какой платформе(-ах) работает ваша тестовая среда, вы можете установить такое регулярное выражение платформы:

```bash
[testenv]
platform = linux2|darwin
```

Если выражение не соответствует `sys.platform`, тестовая среда будет пропущена.

## Разрешение команд, отличных от virtualenv

_Новое в версии 1.5_.

Иногда вы можете захотеть использовать инструменты, которых нет в вашем **virtualenv**, такие как **make**, **bash** или другие. Чтобы избежать предупреждений, вы можете использовать конфигурацию **allowlist\_externals** в блоке **testenv**:

```bash
# содержание tox.ini
[testenv]
allowlist_externals = make
                      /bin/bash
```

## Зависимости от файла requirements.txt или определения ограничений

_Новое в версии 1.6.1_.

(экспериментально) Если у вас есть файл `requirements.txt` или файл `constraints.txt`, вы можете добавить его в свою переменную **deps** следующим образом:

```bash
[testenv]
deps = -rrequirements.txt
```

или:

```bash
[testenv]
deps = -cconstraints.txt
```

или:

```bash
[testenv]
deps =
    -rrequirements.txt
    -cconstraints.txt
```

Все команды установки выполняются с использованием `{toxinidir}` (каталог, в котором находится `tox.ini`) в качестве текущего рабочего каталога. Следовательно, базовая установка **pip** предполагает, что файл `requirements.txt` или `constraints.txt` существует в `{toxinidir}/requirements.txt` или `{toxinidir}/constraints.txt`.

Фактически это побочный эффект, когда все элементы списка зависимостей напрямую передаются в **pip**.

Для получения дополнительных сведений о файлах `requirements.txt` или `constraints.txt` см .:

* [https://pip.pypa.io/en/stable/user\_guide/#requirements-files](https://pip.pypa.io/en/stable/user\_guide/#requirements-files)
* [https://pip.pypa.io/en/stable/user\_guide/#constraints-files](https://pip.pypa.io/en/stable/user\_guide/#constraints-files)

## Использование другого URL-адреса PyPI по умолчанию

Чтобы установить зависимости и пакеты с другого сервера PyPI по умолчанию, вы можете ввести в интерактивном режиме:

```bash
tox -i https://pypi.my-alternative-index.org
```

Это заставляет **tox** устанавливать зависимости, а на этапе установки **sdist** использовать указанный URL в качестве сервера индекса.

Вы можете вызвать тот же эффект, используя переменную среды **PIP\_INDEX\_URL**. Эту переменную также можно установить в `tox.ini`:

```bash
[tox]
setenv =
    PIP_INDEX_URL = https://pypi.my-alternative-index.org
```

В качестве альтернативы конфигурация, в которой **PIP\_INDEX\_URL** может быть переопределена из среды (если не установлена по умолчанию, то установить `https://pypi.my-alternative-index.org`):

```bash
[tox]
setenv =
    PIP_INDEX_URL = {env:PIP_INDEX_URL:https://pypi.my-alternative-index.org}
```

## Установка зависимостей с нескольких серверов PyPI

Вы можете настроить **tox** для установки зависимостей с нескольких серверов PyPI, используя переменную среды **PIP\_EXTRA\_INDEX\_URL**:

```bash
[tox]
setenv =
    PIP_EXTRA_INDEX_URL = https://mypypiserver.org

[testenv]
deps =
    # docutils будет установлен прямо из PyPI
    docutils
    # mypackage отсутствующий в PyPI будет установлен с пользовательского URL-адреса PyPI
    mypackage
```

Эта конфигурация установит **docutils** с сервера Python PYPI по умолчанию и установит **mypackage** с нашего сервера индексирования по URL-адресу `https://mypypiserver.org`.

## Дальнейшая настройка установки

_Новое в версии 1.6_.

По умолчанию **tox** использует **pip** для установки пакетов, как тестируемого пакета, так и любых зависимостей, указанных в `tox.ini`. Вы можете полностью настроить команду установки **tox** с помощью параметра **`install_command = ARGV`**, специфичного для **testenv**. Например, чтобы использовать параметры **pip** `--find-links` и -`-no-index` для указания альтернативного источника для ваших зависимостей:

```bash
[testenv]
install_command = pip install --pre --find-links https://packages.example.com --no-index {opts} {packages}
```

## Принудительное воссоздание виртуальных сред

**Новое в версии 0.9**.

Чтобы заставить **tox** воссоздать (конкретную) виртуальную среду:

```bash
tox --recreate -e py27
```

вызовет полную переустановку существующей среды **py27** (или создаст ее заново, если она не существует).

## Передача переменных среды

_Новое в версии 2.0_.

По умолчанию **tox** будет передавать только переменную среды **PATH** (и в Windows **SYSTEMROOT** и **PATHEXT**) из вызова **tox** в тестовые среды. Если вы хотите передать дополнительные переменные среды, вы можете использовать опцию **passenv**:

```bash
[testenv]
passenv = LANG
```

Когда ваши тестовые команды будут выполнены, они будут выполняться с той же настройкой **LANG**, что и тот, с которым был вызван **tox**.

## Установка переменных окружения

_Новое в версии 1.0_.

Если вам нужно установить переменную среды, например **PYTHONPATH**, вы можете использовать директиву **setenv**:

```bash
[testenv]
setenv = PYTHONPATH = {toxinidir}/subdir
```

Когда ваши тестовые команды выполняются, они будут выполняться с настройкой **PYTHONPATH**, что заставит Python также импортировать из **subdir** ниже каталога, в котором находится ваш файл `tox.ini`.

## Особое обращение с PYTHONHASHSEED

_Новое в версии 1.6.2_.

По умолчанию **tox** устанавливает [PYTHONHASHSEED](https://docs.python.org/3/using/cmdline.html#envvar-PYTHONHASHSEED) для тестовых команд на случайное целое число, генерируемое при вызове **tox**. Это имитирует рандомизацию хэша Python, включенную по умолчанию, начиная с [Python 3.3](https://docs.python.org/3/whatsnew/3.3.html#builtin-functions-and-types). Чтобы помочь воспроизвести ошибки теста, **tox** отображает значение **PYTHONHASHSEED** в выходных данных теста.

Вы можете указать **tox** использовать явное начальное значение хэша с помощью параметра командной строки `--hashseed` в **tox**. Вы также можете переопределить начальное значение хэша для каждой тестовой среды в `tox.ini` следующим образом:

```bash
[testenv]
setenv = PYTHONHASHSEED = 100
```

Если вы хотите отключить эту функцию, вы можете передать параметр командной строки `--hashseed = noset` при вызове **tox**. Вы также можете отключить его из файла `tox.ini`, установив `PYTHONHASHSEED = 0`, как описано выше.

## Интеграция с командой «setup.py test»

{% hint style="danger" %}
**setup.py test** устарел и будет удален в будущей версии.
{% endhint %}

## Игнорирование кода выхода команды

В некоторых случаях вы можете проигнорировать код выхода из команды. Например:

```bash
[testenv:py27]
commands = coverage erase
       {envbindir}/python setup.py develop
       coverage run -p setup.py test
       coverage combine
       - coverage html
       {envbindir}/flake8 loads
```

Используя префикс `-`, аналогичный строке рецепта **make**, вы можете игнорировать код выхода для этой команды.

## Сжатие матрицы зависимостей

Если у вас есть большая матрица зависимостей, версий и/или сред Python, вы можете использовать [генеративный список envlist](../specifikaciya-konfiguracii-tox.md#envlist-generativnykh-imen) и [условные настройки](../specifikaciya-konfiguracii-tox.md#faktory-i-faktorno-uslovnye-nastroiki), чтобы выразить это в краткой форме:

```bash
[tox]
envlist = py{36,37,38}-django{22,30}-{sqlite,mysql}

[testenv]
deps =
    django22: Django>=2.2,<2.3
    django30: Django>=3.0,<3.1
    # используйте PyMySQL, если в имени env присутствуют факторы "py37" и "mysql"
    py38-mysql: PyMySQL
    # используйте urllib3, если в имени env присутствует любое из "py36" или "py37"
    py36,py37: urllib3
    # mocking sqlite на 3.6 и 3.7, если присутствует фактор sqlite
    py{36,37}-sqlite: mock
```

## Использование генеративных имен разделов

Предположим, у вас есть бинарные пакеты, и вам нужно запустить тесты как в 32**-**, так и в 64-битных системах. Вы также хотите, чтобы среда создавала вашу виртуальную среду для разработчиков.

```bash
[testenv]
basepython =
    py38-x86: python3.8-32
    py38-x64: python3.8-64
commands = pytest

[testenv:py38-{x86,x64}-venv]
usedevelop = true
envdir =
    x86: .venv-x86
    x64: .venv-x64
commands =
```

## Запретить символические ссылки в virtualenv

По умолчанию **virtualenv** будет использовать символические ссылки для указания на системные файлы, модули python и т. д. Если вы хотите, чтобы файлы были скопированы вместо этого, возможно, потому что ваша файловая система не может обрабатывать символические ссылки, вы можете указать **virtualenv** использовать «`–always-copy` », предназначенный именно для этой цели, путем установки директивы **alwayscopy** в вашей среде:

```bash
[testenv]
alwayscopy = True
```

## Параллельный режим

**tox** позволяет запускать среды параллельно:

* Вызвать с помощью флага `--parallel` или `-p`. После завершения фазы упаковки **tox** будет запускаться в параллельных процессах среды **tox** (запускает новый экземпляр интерпретатора **tox**, но проходит через все флаги хоста и переменные среды).
* `-p` принимает аргумент, определяющий степень распараллеливания, по умолчанию **auto**:
  * **all** для параллельного запуска всех вызываемых сред,
  * **auto**, чтобы ограничить его количеством ЦП,
  * или передайте целое число, чтобы установить этот предел.
* В параллельном режиме отображается индикатор хода выполнения при параллельном запуске **tox** сред и отчет о результатах, как только они завершаются, с прикрепленным временем продолжительности, понятным для человека. Этот счетчик можно отключить, установив для переменной среды **TOX\_PARALLEL\_NO\_SPINNER** значение `1`.
* Параллельный режим по умолчанию показывает вывод только сбойных сред и сред, помеченных как **`parallel_show_output`**` ``= True`.
* Теперь существует концепция зависимости между средами (указывается через **depends**), **tox** будет переупорядочивать список сред для выполнения, чтобы удовлетворить эти зависимости (также при последовательном запуске). Кроме того, в параллельном режиме будет планироваться запуск среды **tox** только после завершения всех ее зависимостей (независимо от их результата).

{% hint style="danger" %}
**depends** не втягивает зависимости в цель запуска, например, если вы выбираете **py27**, **py36**, покрытие с помощью **-e** tox будет запускать только эти три (даже если **coverage** может указывать, как **depends** и от других целей, таких как **py27**, **py35**, **py36** , **py37**).
{% endhint %}

* `--parallel-live / -o` позволяет отображать прямой вывод стандартного вывода и ошибки, а также отключает отчеты, описанные выше.
* Примечание: параллельная оценка отключает стандартный ввод. Если вам нужен стандартный ввод, используйте непараллельный вызов.

Пример окончательного вывода:

```bash
$ tox -e py27,py36,coverage -p all
✔ OK py36 in 9.533 seconds
✔ OK py27 in 9.96 seconds
✔ OK coverage in 2.0 seconds
___________________________ summary ______________________________________________________
  py27: commands succeeded
  py36: commands succeeded
  coverage: commands succeeded
  congratulations :)
```

Пример индикатора выполнения, показывающий вращающийся счетчик, количество запущенных сред и их список (ограничен до 120 символов):

```bash
⠹ [2] py27 | py36
```

## Автоматическая подготовка tox

В случае, если хост **tox** не удовлетворяет ни **minversion**, ни **requires**, tox теперь автоматически создаст виртуальную среду под **provision\_tox\_env**, которая удовлетворяет этим ограничениям, и делегирует все вызовы этой мета-среде. Это должно позволить автоматически удовлетворять ограничениям в вашей среде **tox**, если у вас есть как минимум версия `3.8.0` tox.

Например, приведено:

```bash
[tox]
minversion = 3.10.0
requires = tox_venv >= 1.0.0
```

если пользователь запускает его с `tox 3.8.0` или более поздней версии, установленный **tox** автоматически обеспечит соответствие минимальной версии и требуемых ограничений, создав виртуальную среду в папке `.tox`, а затем установив в нее `tox>=3.10.0` и `tox_venv>=1.0.0`. После этого все вызовы **tox** перенаправляются в **tox**, установленный внутри папки `.tox\.tox` (называемый метатоксом или автоматически подготовленным **tox**).

Это позволяет **tox** автоматически настраивать себя со всеми своими плагинами для текущего проекта. Если **tox** хоста удовлетворяет ограничениям, выраженным в **require** и **minversion**, такая подготовка не выполняется (чтобы избежать затрат на установку, когда это явно не требуется).
