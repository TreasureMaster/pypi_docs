# Спецификация конфигурации tox

## Обнаружение конфигурации

На данный момент **tox** поддерживает три расположения конфигурации с приоритетом в следующем порядке:

1. &#x20;`pyproject.toml`,
2. &#x20;`tox.ini`,
3. &#x20;`setup.cfg`.

Что касается формата конфигурации, на данный момент мы поддерживаем только стандартный формат [ConfigParser](https://docs.python.org/3/library/configparser.html) «**ini-style**» (в ближайшее время планируется добавить чистый **TOML**). `tox.ini` и `setup.cfg` являются такими файлами. Обратите внимание, что `setup.cfg` требует, чтобы контент находился в разделах `tox:tox` и `testenv`, в противном случае он игнорируется. `pyproject.toml`, с другой стороны, находится в формате **TOML**. Однако можно встроить формат в стиле `ini` под ключ `tool.tox.legacy_tox_ini` как многострочную строку.

Ниже вы найдете спецификацию формата **ini-style**, но вы можете сначала просмотреть некоторые [примеры конфигурации и использования](primery-tox/) **tox** и использовать эту страницу в качестве справочника.

## Глобальные настройки tox

Глобальные настройки определены в разделе **tox** как:

```bash
[tox]
minversion = 3.4.0
```

* **minversion** - Определяет минимальную версию **tox**, необходимую для запуска; если версия **tox** хоста меньше этой, инструмент создаст среду и предоставит ей версию **tox**, которая удовлетворяет этому в разделе **provision\_tox\_env**.
* **requires** (LIST of PEP-508) - _Новое в версии 3.2.0_. Указывает пакеты python, которые должны существовать вместе с установкой **tox**, чтобы сборка **tox** могла быть запущена (должна быть совместима с PEP-508). Используйте это, чтобы указать требования к плагину (или версию **virtualenv** - определяет версии **pip**, **setuptools** и **wheel** по умолчанию, с которых начинаются среды **tox**). Если эти зависимости не указаны, **tox** создаст среду **provision\_tox\_env**, чтобы они были удовлетворены, и делегирует ей все вызовы.

```bash
[tox]
requires = tox-pipenv
           setuptools >= 30.0.0
```

* &#x20;**provision\_tox\_env**`=.tox`(string) - Новое в версии 3.8.0. Имя виртуальной среды, используемой для предоставления токена со всеми указанными внутри зависимостями, **requires** и **minversion**.
* &#x20;**toxworkdir**`={toxinidir}/.tox`(PATH) - Каталог, в котором **tox** будет генерировать свои среды, будет создан, если он не существует.
* &#x20;**temp\_dir**`={toxworkdir}/.tmp`(PATH) - Каталог, куда помещать временные файлы **tox**. Например: мы создаем жесткую ссылку (если возможно, иначе новую копию) в этом каталоге для пакета проекта. Это гарантирует правильную работу **tox** при параллельных запусках (поскольку каждый сеанс будет иметь свою собственную копию пакета проекта - например, исходный дистрибутив).
* &#x20;**skipsdist**`=false`(true | false) - Флаг, указывающий, выполнять операцию упаковки или нет. Установите значение `true` при использовании **tox** для приложения вместо библиотеки.
* &#x20;**setupdir**`={toxinidir}`(PATH) - Указывает, где находится корневой файл упаковки (исторически - `setup.py` для **setuptools**). Это будет рабочий каталог при выполнении упаковки.
* &#x20;**distdir**`={toxworkdir}/dist`(PATH) - Каталог, в который следует поместить пакетный исходный код. Обратите внимание, что это очищается в начале каждого вызова упаковки.
* &#x20;**sdistsrc**`={toxworkdir}/dist`(PATH) - Не создавайте пакет, а используйте последний пакет, доступный по этому пути. Вы можете переопределить его с помощью флага командной строки `--installpkg`.
* &#x20;**distshare**`={homedir}/.tox/distshare`(PATH) - Папка, в которую будет перемещен упакованный исходный код, не очищается между вызовами упаковки. В Jenkins (существует переменная среды JENKINS\_URL или HUDSON\_URL) путь по умолчанию - `{toxworkdir}/distshare`.
* &#x20;**envlist** (значения, разделенные запятыми) - Определение списка окружений, в котором должен работать **tox**, происходит в следующем порядке (если он найден, дальнейшие поиски не производятся):
  * параметр командной строки `-eENVLIST`
  * переменная среды `TOXENV`
  * `envlist` файла `tox.ini`

_Новое в версии 3.4.0_: какие среды **tox** запускаются во время вызова **tox**, можно дополнительно фильтровать с помощью регулярного выражения **TOX\_SKIP\_ENV** переменной среды операционной системы (например, `py27.*` Означает **не оценивать** среды, которые начинаются с ключа `py27`). Пропущенные среды будут регистрироваться на втором уровне детализации.

* &#x20;**skip\_missing\_interpreters**`=config`(config | true | false) - _Новое в версии 1.7.2_. Установка этого значения в `true` приведет к тому, что **tox** вернет успех, даже если некоторые из указанных сред отсутствуют. Это полезно для некоторых систем CI или при запуске в окне разработчика, где у вас может быть установлена только часть всех поддерживаемых вами интерпретаторов, но вы не хотите отмечать сборку как неудачную из-за этого. Как и ожидалось, переключатель командной строки всегда переопределяет этот параметр, если он передан при вызове. Установка для него `config` означает, что значение считывается из файла конфигурации.
* &#x20;**ignore\_basepython\_conflict**`=false`(true | false) - _Новое в версии 3.1.0_. **tox** позволяет установить версию python для среды с помощью параметра _**basepython**_. Если он не установлен, **tox** может установить значение по умолчанию из имени среды (например, `py37` подразумевает **Python 3.7**). На этом этапе стало ожидаемым совпадение версии python с именем среды, что привело к сюрпризам, когда некоторые конфигурации этого не сделали. Чтобы помочь с рассудком пользователей, будет выдаваться предупреждение всякий раз, когда версия имени среды не совпадает с этим ожиданием. В будущей версии **tox** это предупреждение станет ошибкой. Кроме того, мы разрешаем жесткое применение этого правила (и обход предупреждения), установив для этого флага значение `true`. В таких случаях мы игнорируем _**basepython**_ и вместо этого всегда используем базовый python, подразумеваемый именем Python. Это позволяет вам настраивать _**basepython**_ в глобальном тесте, не затрагивая среды, которые подразумевают базовые версии Python.
* &#x20;**isolated\_build**`=false`(true | false) - _Новое в версии 3.3.0_. Активировать изолированную среду сборки. **tox** будет использовать виртуальную среду для построения исходного дистрибутива из исходного дерева. Для инструментов сборки и аргументов используйте файл `pyproject.toml`, как указано в [PEP-517](https://www.python.org/dev/peps/pep-0517/) и [PEP-518](https://www.python.org/dev/peps/pep-0518/). Чтобы указать версию Python для виртуальной среды, используйте раздел конфигурации **isolated\_build\_env**.
* &#x20;**isolated\_build\_env**`=.package`(string) - _Новое в версии 3.3.0_. Имя виртуальной среды, используемой для создания исходного дистрибутива из исходного дерева.

### Переопределение Jenkins

Можно переопределить глобальные настройки внутри экземпляра **Jenkins** (обнаружение выполняется путем проверки наличия переменной среды **JENKINS\_URL**) с помощью раздела `tox: jenkins`:

```bash
[tox:jenkins]
commands = ...  # переопределить настройки для контекста jenkins
```

## Среда окружения tox

Среды тестирования определяются в разделе `testenv` и отдельных разделах `testenv: NAME`, где **NAME** - это имя конкретной среды.

```bash
[testenv]
commands = ...

[testenv:NAME]
commands = ...
```

Настройки, определенные в разделе **testenv** верхнего уровня, автоматически наследуются отдельными средами, если они не отменены. Имена тестовой среды могут состоять из буквенно-цифровых символов и дефисов; например: `py38-django30`. Имя будет разделено тире на несколько факторов, то есть `py38-django30` будет разделен на два фактора: `py38` и `django30`. **tox** определяет ряд факторов по умолчанию, которые соответствуют различным версиям и реализациям Python и предоставляют значения по умолчанию для _**basepython**_:

* `pyNM`: настраивает `basepython = pythonN.M`
* `pyN`: настраивает `basepython = pythonN`
* `py`: настраивает `basepython = python`
* `pypyN`: настраивает `basepython = pypyN`
* `pypy`: настраивает `basepython = pypy`
* `jythonN`: настраивает `basepython = jythonN`
* `jython`: настраивает `basepython = jython`

Также можно определить так называемые **генеративные имена**, когда отдельный раздел соответствует нескольким средам. Например, `py{37,38}-django{30,31}` сгенерирует четыре среды, каждая из которых состоит из двух факторов: `py37-django30` (**py37**, **django30**), `py37-django31` (**py37**, **django31**), `py38-django30` (**py38** , **django30**) и `py38-django31` (**py38**, **django31**). В совокупности эти функции дают возможность писать очень сжатые файлы `tox.ini`. Это обсуждается [ниже](specifikaciya-konfiguracii-tox.md#generaciya-okruzhenii-uslovnye-nastroiki).

## Настройки среды tox

Полный список настроек, которые вы можете поместить в разделы `testenv *`:

* &#x20;**basepython** (NAME-OR-PATH) - Имя или путь к интерпретатору Python, который будет использоваться для создания виртуальной среды, на практике определяет python, для которого мы будем создавать виртуальную изолированную среду. Используйте это, чтобы указать версию Python для среды **tox**. Если не указан, факторы виртуального окружения (например, часть имени) будут использоваться для его автоматической установки. Например, `py37` означает **Python3.7**, `py3` означает **Python3**, а `py` означает **Python**. Среда **provision\_tox\_env** не наследует этот параметр из раздела _**toxenv**_. _Изменено в версии 3.1_: после разрешения этого значения, если интерпретатор сообщает номер версии, отличный от предполагаемого в имени, по умолчанию будет напечатано предупреждение. Однако, если **ignore\_basepython\_conflict** установлен, значение игнорируется, и мы принудительно используем **basepython**, подразумеваемый именем фактора.
* &#x20;**commands**(ARGVLIST) - Команды, вызываемые для тестирования. Выполняется только при успешном завершении **commands\_pre**. Каждая строка интерпретируется как одна команда; однако команду можно разделить на несколько строк, завершив строку символом `\`. Команды будут выполняться одна за другой последовательно, пока одна из них не выйдет из строя (их код выхода не равен нулю) или все они не будут выполнены успешно. Код выхода команды можно игнорировать (это означает, что они всегда считаются успешными), добавив к команде дефис (`-`) - это похоже на то, как работает `make` строки рецепта. Результат среды считается успешным только в том случае, если все команды (эти + настройка + разборка) были выполнены успешно (код выхода игнорируется с помощью значения кода выхода `-` или успеха, равного нулю).

{% hint style="info" %}
**ПРИМЕЧАНИЕ:**

двоичный путь виртуальной среды (папка **bin** внутри) добавляется к **PATH** ОС, что означает, что команды сначала будут пытаться разрешить исполняемый файл изнутри виртуальной среды, и только после этого вне ее. Поэтому **python** переводится как **python** виртуальных сред (имеющий ту же версию среды выполнения, что и **basepython**), а **pip** переводится как **pip** виртуальных сред.
{% endhint %}

* &#x20;**commands\_pre** (ARGVLIST) - _Новое в версии 3.4_. Команды для запуска перед запуском **commands**. Вся логика оценки и конфигурации применяется из **commands**.
* &#x20;**commands\_post** (ARGVLIST) - Новое в версии 3.4. Команды для запуска после выполнения **commands**. Выполняется независимо от результата обеих **commands** и **commands\_pre**. Вся логика оценки и конфигурации применяется из **commands**.
* &#x20;**install\_command**`=python -m pip install {opts} {packages}`(ARGV) - _Новое в версии 1.6_. Определяет команду, используемую для установки пакетов в виртуальную среду; как тестируемый пакет, так и его зависимости (определенные с помощью **deps**). Должен содержать ключ замены `{packages}`, который будет заменен пакетом(ами) для установки. Вы также должны принять `{opts}`, если используете **pip** - он будет содержать параметры сервера индекса, такие как `--pre` (настроенный как **pip\_pre**) и, возможно, параметры индекса из устаревшего параметра **indexserver**.
* &#x20;**list\_dependencies\_command**`=python -m pip freeze`(ARGV) - _Новое в версии 2.4_. Параметр **list\_dependencies\_command** используется для вывода списка пакетов, установленных в виртуальной среде.
* &#x20;**ignore\_errors**`=false`(true | false) - Новое в версии 2.0. Если `false`, ненулевой код выхода из одной команды прервет выполнение команд для этой среды. Если `true`, ненулевой код выхода из одной команды будет проигнорирован, и будут выполняться дальнейшие команды. Общий статус будет «commands failed», т.е. **tox** выйдет с ненулевым значением в случае сбоя какой-либо команды. Может быть полезно отметить, что этот параметр аналогичен параметру `-k` или `--keep-going` в GNU **Make**. Обратите внимание, что в `tox < 2.0` поведение **tox** по умолчанию в отношении обработки ошибок команд изменилось. `tox >= 2.0` по умолчанию прерывается из-за ошибки, что более безопасно и более типично для инструментов CI и выполнения команд, поскольку нет смысла запускать тесты, если установка какого-либо предварительного условия не удалась, и нет смысла пытаться развернуть, если тесты не прошли.
* &#x20;**pip\_pre**`=false`(true | false) - Новое в версии 1.9. Если `true`, добавляет `--pre` к параметрам, переданным в **install\_command**. Если **install\_command** использует **pip**, это приведет к установке последней доступной предварительной версии любых зависимостей без указанной версии. Если `false`, **pip** будет устанавливать только последние версии незакрепленных зависимостей. Передача параметра `--pre` в командной строке **tox** приведет к тому, что это будет `true` для всех **testenvs**. Не устанавливайте этот параметр, если ваша **install\_command** не использует **pip**.
* &#x20;**allowlist\_externals** (MULTI-LINE-LIST) - Новое в версии 3.18. В каждой строке указывается имя команды (в формате шаблона в стиле glob), которое можно использовать в разделе **commands**, не вызывая предупреждения «не установлено в virtualenv». Пример: если вы используете unix **make** для запуска тестов, вы можете указать `allowlist_externals = make` или `allowlist_externals = /usr/bin/make`, если хотите большей точности. Если вы в любом случае не хотите, чтобы **tox** выдавал предупреждение, просто используйте `allowlist_externals = *`, который будет соответствовать всем командам (не рекомендуется).

{% hint style="warning" %}
**whitelist\_externals** имеет то же значение и использование, что и **allowlist\_externals**, но теперь устарело.
{% endhint %}

* &#x20;**changedir**`={toxinidir}`(PATH) - Переходит в этот рабочий каталог при выполнении тестовой команды.

{% hint style="info" %}
Если каталог еще не существует, он будет создан.
{% endhint %}

* &#x20;**deps**(MULTI-LINE-LIST) - Зависимости среды - устанавливаются в среду ((см. **install\_command**) до проекта после создания среды. Одна зависимость (файл, URL-адрес или имя пакета) на строку. Должна соответствовать [PEP-508](https://www.python.org/dev/peps/pep-0508/). Все команды установщика выполняются с использованием [toxinidir](specifikaciya-konfiguracii-tox.md#globalno-dostupnye-zamesheniya) как текущий рабочий каталог.

```bash
[testenv]
deps =
    pytest
    pytest-cov >= 3.5
    pywin32 >=1.0 ; sys_platform == 'win32'
    octomachinery==0.0.13  # pyup: < 0.1.0 # disable feature updates
```

_Изменено в версии 2.3_. Поддержка серверов индексирования теперь не рекомендуется, и ее использование не рекомендуется.

_Изменено в версии 3.9_. Поддержка комментариев в той же строке, что и зависимость. При подаче контента в инструмент установки мы удаляем контент (включая) из первого маркера комментария (`#`), перед которым стоит один или несколько пробелов. Например, если зависимость - `octomachinery == 0.0.13 # pyup: <0.1.0 # disable feature updates`, она будет превращена только в `octomachinery == 0.0.13`.

* &#x20;**platform** (REGEX) - _Новое в версии 2.0_. **testenv** может определять новую настройку _**platform**_ как регулярное выражение. Если определено непустое выражение, которое не соответствует строке `sys.platform`, вся тестовая среда будет пропущена, и ни одна из команд не будет выполнена. Запуск `tox -e <platform_name>` запустит команды для конкретной платформы и пропустит остальные.
* &#x20;**setenv** (MULTI-LINE-LIST) - Новое в версии 0.9. Каждая строка содержит параметр переменной среды `NAME = VALUE`, который будет использоваться для всех вызовов тестовых команд, а также для установки пакета **sdist** в виртуальную среду. Обратите внимание, что при обновлении переменной пути вы можете рассмотреть возможность использования подстановки переменной для текущего значения и обработки разделителя пути.

```bash
[testenv]
setenv   =
    PYTHONPATH = {env:PYTHONPATH}{:}{toxinidir}
```

_Новое в версии 3.20_. Поддержка комментариев. Строки, начинающиеся с символа `#`, игнорируются.

Поддержка файлов среды. Строки, начинающиеся с `file|` содержат путь к загружаемому файлу среды. Правила в файле среды такие же, как и в **setenv** (такая же замена и поддержка комментариев).

* &#x20;**passenv** (SPACE-SEPARATED-GLOBNAMES) - _Новое в версии 2.0_. Список имен переменных среды с подстановочными знаками, которые должны быть скопированы из среды вызова **tox** в тестовую среду при выполнении тестовых команд. Если указанная переменная среды не существует в среде вызова **tox**, она игнорируется. Вы можете использовать `*` и `?` чтобы сопоставить несколько переменных среды с одним именем. Список имен переменных среды не чувствителен к регистру, и будут переданы все переменные, которые совпадают в верхнем регистре. Например, при прохождении `A` будут переданы обе - как `A`, так и `a`. Некоторые переменные всегда передаются, чтобы обеспечить базовую функциональность стандартных библиотечных функций или инструментов, таких как **pip**:
  * проходит на всех платформах:  `CURL_CA_BUNDLE`, `PATH`, `LANG`, `LANGUAGE`, `LD_LIBRARY_PATH`, `PIP_INDEX_URL`, `PIP_EXTRA_INDEX_URL`, `REQUESTS_CA_BUNDLE`, `SSL_CERT_FILE`, `HTTP_PROXY`, `HTTPS_PROXY`, `NO_PROXY`
  *   Windows: `SYSTEMDRIVE`, `SYSTEMROOT`, `PATHEXT`, `TEMP`, `TMP`

      `NUMBER_OF_PROCESSORS`, `USERPROFILE`, `MSYSTEM`
  * Другие (например UNIX, macOS):  `TMPDIR`

Вы можете переопределить эти переменные с помощью опции **setenv**. Если определено, переменная среды **TOX\_TESTENV\_PASSENV** (в среде вызова **tox**) может определять дополнительные имена переменных, разделенных пробелами, которые должны быть переданы в среду тестовых команд.

_Изменено в версии 2.7_: **PYTHONPATH** будет передаваться, если явно определен. Если **PYTHONPATH** существует в среде хоста, но не объявлен в **passenv**, будет выдано предупреждение.

* &#x20;**recreate**`=false`(true | false) - Всегда воссоздает виртуальную среду, если эта опция истинна. Если этот параметр имеет значение `false`, механизм разрешения **tox** будет использоваться для определения необходимости воссоздания среды.
* &#x20;**downloadcache** (PATH) - **IGNORED** - поскольку pip-8 имеет кеширование по умолчанию, этот параметр теперь игнорируется. Пожалуйста, удалите его из своих конфигов, так как будущая версия **tox** может выдавать предупреждение.
* &#x20;**sitepackages**`=false`(true | false) - Установите значение `true`, если вы хотите создавать виртуальные среды, которые также имеют доступ к глобально установленным пакетам.

{% hint style="danger" %}
В случаях, когда инструмент командной строки также установлен глобально, вы должны убедиться, что используете инструмент, установленный в **virtualenv**, с помощью **python -m \<command line tool>** (если поддерживается этим инструментом) или **{envbindir} / \<command line tool>**.

Если вы забудете это сделать, вы получите следующее предупреждение:

```bash
WARNING: test command found but not installed in testenv
    cmd: /path/to/parent/interpreter/bin/<some command>
    env: /foo/bar/.tox/python
Maybe you forgot to specify a dependency?
See also the allowlist_externals envconfig setting.
```
{% endhint %}

* &#x20;**alwayscopy**`=false`(true | false) - Установите значение `true`, если вы хотите, чтобы **virtualenv** всегда копировал файлы, а не делал ссылки. Это полезно в ситуациях, когда жесткие ссылки не работают (например, при работе в VMS с гостевой Windows).
* &#x20;**download**`=false`(true | false) - _Новое в версии 3.10_. Установите значение `true`, если вы хотите, чтобы **virtualenv** обновлял **pip/wheel/setuptools** до последней версии. Если (и только если) вы хотите выбрать конкретную версию (не обязательно последнюю), вы можете добавить, например, `VIRTUALENV_PIP = 20.3.3` в ваш **setenv**.
* &#x20;**args\_are\_paths**`=true`(true | false) - Рассматривайте позиционные аргументы, переданные **tox**, как пути файловой системы и - если они существуют в файловой системе - перезаписывайте их в соответствии с измененными. По умолчанию установлено значение "`true`" из-за проверки наличия в файловой системе, обычно можно попробовать перезапись.
* &#x20;**envtmpdir**`={envdir}/tmp`(PATH) - Определяет временный каталог для **virtualenv**, который будет очищаться каждый раз перед вызовом группы тестовых команд.
* &#x20;**envlogdir**`={envdir}/log`(PATH) - Определяет каталог для журналирования, куда **tox** будет помещать журналы вызова инструмента.
* &#x20;**indexserver** (URL) - _Новое в версии 0.9_. (**УСТАРЕЛО**, будет удалено в будущей версии) Многострочное `name = URL` серверов пакетов Python. Зависимости можно указать с помощью указанного сервера индексирования с помощью шаблона `:indexservername:depname`. Определение сервера индекса **default** определяет, откуда устанавливаются зависимости с незаданной областью и установка **sdist**. Пример:

```bash
[tox]
indexserver =
    default = https://mypypi.org
```

заставит **tox** установить все зависимости с этого сервера индекса PyPI (в том числе при установке пакета проекта **sdist**).

* &#x20;**envdir**`={toxworkdir}/{envname}`(PATH) - _Новое в версии 1.5_. Пользователь может установить конкретный путь для среды. Если путь не является абсолютным, он будет рассматриваться как относительный к `{toxinidir}`.
* &#x20;**usedevelop**`=false`(true | false) - Новое в версии 1.6. Устанавливает текущий пакет в режиме разработки с помощью «`setup.py develop`» вместо установки из пакета **sdist**. (Здесь используется параметр `-e` для **pip**, поэтому его следует избегать, если вы указали специальную команду **install\_command**, которая не поддерживает `-e`).
* &#x20;**skip\_install**`=false`(true | false) - Новое в версии 1.9. Не устанавливает текущий пакет. Это можно использовать, когда вам нужно управление **virtualenv**, но вы не хотите устанавливать текущий пакет в эту среду.
* &#x20;**ignore\_outcome**`=false`(true | false) - _Новое в версии 2.2_. Если установлено значение `true`, в результате сбоя этого **testenv** не произойдет сбой **tox**, будет выдано только предупреждение.
* &#x20;**extras** (MULTI-LINE-LIST) - _Новое в версии 2.4_. Список «_**extras**_», который нужно установить с помощью **sdist** или **develop install**. Например, `extras = testing` эквивалентно `[testing]` в команде установки **pip**. Они не устанавливаются, если **skip\_install** имеет значение `true`.
* &#x20;**description**`=no description`(SINGLE-LINE-TEXT) - Краткое описание среды, оно будет использовано для объяснения среды пользователю после перечисления сред для командной строки с любым уровнем детализации выше нуля.
* &#x20;**parallel\_show\_output**`=false`(bool) - _Новое в версии 3.7.0_. Если установлено значение `True`, содержимое вывода всегда будет отображаться при работе в параллельном режиме.
* &#x20;**depends** (значения, разделенные запятыми) - Новое в версии 3.7.0. **tox** это зависит от среды. **tox** попытается запустить все зависимые среды перед запуском этой среды. Формат такой же, как у **envlist** (позволяет использовать фактор).

{% hint style="danger" %}
**depends** не втягивает зависимости в цель запуска, например, если вы выбираете **py27**, **py36**, **coverage** с помощью **-e** tox будет запускать только эти три (даже если **coverage** может указывать, как **depends** и от других целей, таких как **py27**, **py35**, **py36** , **py37**).
{% endhint %}

* &#x20;**suicide\_timeout**`=0.0`(float) - _Новое в версии 3.15.2_. Когда прерывание отправляется через `Ctrl + C` или процесс **tox** завершается с помощью **SIGTERM**, всем процессам переднего плана отправляется **SIGINT**. Параметр `:conf:suicide_timeout` дает запущенному процессу время для очистки и выхода перед получением (в некоторых случаях дубликата) **SIGINT** от **tox**.
* &#x20;**interrupt\_timeout**`=0.3`(float) - _Новое в версии 3.15.0_. Когда **tox** прерывается, он передает сигнал дочернему процессу через `:conf:suicide_timeout` секунд. Если процесс все еще не завершился через `:conf:interrupt_timeout` секунд, он отправляет **SIGTERM**.
* &#x20;**terminate\_timeout**`=0.2`(float) - _Новое в версии 3.15.0_. Когда **tox** прерывается, после ожидания `:conf:interrupt_timeout` секунд, он передает сигнал дочернему процессу, ждет `:conf:interrupt_timeout` секунд, отправляет ему **SIGTERM**, ждет `:conf:terminate_timeout` секунд и отправляет ему **SIGKILL**, если он не получил сигнал выхода.

## Замещения

Любой параметр **key=value** в ini-файле может использовать подстановку значений с помощью шаблона подстановки строк `{...}`.

Вы можете экранировать фигурные скобки с помощью символа `\`, если они вам нужны, например:

```bash
commands = echo "\{posargs\}" = {posargs}
```

Обратите внимание, что некоторые подстановки (например, **posargs**, **env**) могут иметь дополнительные значения, прикрепленные к нему через символ `:` (например, **posargs** - значение по умолчанию, **env** - ключ). В таких подстановках не может быть пробела после символа `:` (например, `{posargs: magic}`, будучи в начале строки внутри конфигурации **ini** (это будет анализироваться как факториал `{posargs`, имеющий значение **magic**).

### Глобально доступные замещения

* &#x20;**{toxinidir}** - каталог, в котором находится `tox.ini`
* &#x20;**{toxworkdir}** - каталог, в котором создаются виртуальные среды и находятся подкаталоги для упаковки.
* &#x20;**{homedir}** - путь к домашнему каталогу пользователя.
* &#x20;**{distdir}** - каталог, в котором будут созданы **sdist**-пакеты
* &#x20;**{distshare}** - (УСТАРЕЛО) каталог, в который будут скопированы пакеты **sdist**, чтобы к ним могли обращаться другие процессы или запуски **tox**.
* &#x20;**{ : }** - Разделитель путей для конкретной ОС (`:` в семействе \* nix, `;` в Windows). Может использоваться в **setenv**, когда целевая переменная является переменной пути (например, **PATH** или **PYTHONPATH**).
* &#x20;**{ / } -** Разделитель каталогов для конкретной ОС (`/` в семействе \* nix, `\` в Windows). Полезно для получения имен файлов из предустановленных путей в качестве аргументов для команд, требующих `\\` в Windows. например `{distdir} {/} file.txt`. Обычно это не требуется при использовании команд, написанных на Python.

### Замещения для разделов, связанных с virtualenv

* &#x20;**{envname} -** имя виртуальной среды
* &#x20;**{envpython} -** путь к виртуальному интерпретатору Python
* &#x20;**{envdir} -** каталог иерархии virtualenv
* &#x20;**{envbindir} -** каталог, в котором расположены исполняемые файлы
* &#x20;**{envsitepackagesdir} -** каталог, в который установлены пакеты. Обратите внимание, что файлы, относящиеся к конкретной архитектуре, могут находиться в другом каталоге.
* &#x20;**{envtmpdir} -** временный каталог среды
* &#x20;**{envlogdir} -** каталог журнала среды

### Замещения переменных среды

Если вы укажете такую строку подстановки:

```bash
{env:KEY}
```

тогда значение будет получено как `os.environ ['KEY']` и вызовет ошибку, если переменная среды не существует.

### Замещения переменных среды значениями по умолчанию

Если вы укажете такую строку подстановки:

```bash
{env:KEY:DEFAULTVALUE}
```

тогда значение будет получено как `os.environ ['KEY']` и заменено на **DEFAULTVALUE**, если переменная среды не существует.

Если вы укажете такую строку подстановки:

```bash
{env:KEY:}
```

тогда значение будет получено как `os.environ ['KEY']` и заменено пустой строкой, если переменная среды не существует.

Замены также могут быть вложенными. В этом случае они раскрываются, начиная с самого внутреннего выражения:

```bash
{env:KEY:{env:DEFAULT_OF_KEY}}
```

приведенный выше пример примерно эквивалентен: `os.environ.get ('KEY', os.environ ['DEFAULT_OF_KEY'])`

### Замещения интерактивной оболочки

Можно ввести значение конфигурации только тогда, когда **tox** запущен в интерактивной оболочке (стандартный ввод):

```bash
{tty:ON_VALUE:OFF_VALUE}
```

Первое значение - это значение, которое нужно ввести, когда интерактивный терминал доступен, второе значение - это значение, которое следует использовать, когда его нет. Последнее не является обязательным. Хороший вариант использования для этого, например, передача флага `--pdb` для **pytest**.

### Замещения позиционных аргументов в командах

_Новое в версии 1.0_.

Если вы укажете такую строку подстановки:

```bash
{posargs:DEFAULTS}
```

тогда значение будет заменено позиционными аргументами, указанными в команде **tox**:

```bash
tox arg1 arg2
```

В этом случае часть позиционного аргумента будет заменена на `arg1 arg2`. Если позиционные аргументы не указаны, вместо них будет использоваться значение **DEFAULTS**. Если **DEFAULTS** содержит другие строки подстановки, такие как `{env: *}`, они будут интерпретированы.,

Используйте двойной - если вы также хотите передать параметры базовой тестовой команде, например:

```bash
tox -- --opt1 ARG1
```

заставит `--opt1 ARG1` появляться во всех тестовых командах, где были указаны `[]` или `{posargs}`. По умолчанию (см. параметр **args\_are\_paths**), **tox** перезаписывает каждый позиционный аргумент, если это относительный путь и существует в файловой системе, чтобы он стал путем относительно параметра **changedir**.

Предыдущие версии **tox** поддерживали шаблон `[.*]` Для обозначения позиционных аргументов значениями по умолчанию. Этот формат устарел. Используйте `{posargs: DEFAULTS}`, чтобы указать их.

### Замена значений из других разделов

_Новое в версии 1.4_.

На значения из других разделов можно ссылаться через:

```bash
{[sectionname]valuename}
```

который можно использовать, чтобы избежать повторения значений конфигурации. Вы можете поместить значения по умолчанию в один раздел и ссылаться на них в других, чтобы не повторять одни и те же значения:

```bash
[base]
deps =
    pytest
    mock
    pytest-xdist

[testenv:dulwich]
deps =
    dulwich
    {[base]deps}

[testenv:mercurial]
deps =
    mercurial
    {[base]deps}
```

## Генерация окружений, условные настройки

_Новое в версии 1.8_.

Предположим, вы хотите протестировать свой пакет на **python2.7**, **python3.6** и на нескольких версиях зависимости, скажем, **Django 1.5** и **Django 1.6**. Вы можете сделать это, записав `2*2 = 4 [testenv:*]` раздела, а затем перечислив их все в **envlist**.

Однако лучший подход выглядит так:

```bash
[tox]
envlist = {py27,py36}-django{15,16}

[testenv]
deps =
    pytest
    django15: Django>=1.5,<1.6
    django16: Django>=1.6,<1.7
    py36: unittest2
commands = pytest
```

Здесь используются два новых средства `tox-1.8`:

* генеративные объявления **envlist**, где каждое **envname** состоит из частей среды или «факторов»
* Специфические настройки «фактора»

Давайте рассмотрим это шаг за шагом.

### envlist генеративных имен

```bash
envlist = {py36,py27}-django{15,16}
```

Это синтаксис в стиле **bash**, который создаст `2 * 2 = 4` имени среды, например:

```bash
py27-django15
py27-django16
py36-django15
py36-django16
```

Вы по-прежнему можете явно перечислять среды вместе с сгенерированными:

```bash
envlist = {py27,py36}-django{15,16}, docs, flake
```

Имейте в виду, что символы пробела (кроме новой строки) внутри `{}` удаляются, поэтому следующая строка определяет те же имена среды:

```bash
envlist = {py27,py36}-django{ 15, 16 }, docs, flake
```

{% hint style="info" %}
Чтобы понять, как варианты будут создавать значения разделов, вы можете попросить **tox** показать их расширение с помощью новой опции:

```bash
$ tox -l
py27-django15
py27-django16
py36-django15
py36-django16
docs
flake
```
{% endhint %}

### Имена генеративных секций

_Новое в версии 3.15_.

Используя аналогичный синтаксис, можно создавать разделы:

```bash
[testenv:py{27,36}-flake]
```

Это эквивалентно определению отдельных разделов:

```bash
$ tox -a
py27-flake
py36-flake
```

Это полезно, когда вам нужна среда, отличная от среды по умолчанию, но вы все же хотите использовать факторно-условные настройки.

### Факторы и факторно-условные настройки

Как обсуждалось ранее, части имени среды, разделенные дефисами, называются факторами и могут использоваться для условной установки значений. В настройках списка, таких как **deps** или **commands**, вы можете свободно смешивать необязательные строки с безусловными:

```bash
[testenv]
deps =
    pytest
    django15: Django>=1.5,<1.6
    django16: Django>=1.6,<1.7
    py36: unittest2
```

Читая его построчно:

* **pytest** будет включен безоговорочно,
* `Django>=1.5, <1.6` будет включен для сред, содержащих фактор `django15`,
* `Django>=1.6, <1.7` аналогично зависит от фактора `django16`,
* **unittest2** будет загружен для сред `Python 3.6`.

**tox** предоставляет ряд факторов по умолчанию, соответствующих версиям интерпретатора Python. Приведенная выше условная настройка приведет к тому, что в качестве базового python будет использоваться `python3.6` или `python2.7`, например `python3.6` выбирается, если текущая среда содержит фактор **py36**.

{% hint style="info" %}
Настройка **basepython** для сред с использованием коэффициентов по умолчанию приведет к предупреждению. Настройте **ignore\_basepython\_conflict**, если вы хотите явно игнорировать эти конфликты, что позволит вам определить глобальный **basepython** для всех сред, кроме тех, которые имеют коэффициенты по умолчанию.
{% endhint %}

### Комплексные факторные условия

Иногда требуется указать одну и ту же строку для нескольких факторов или создать специальный случай для комбинации факторов. Вот как это сделать:

```bash
[tox]
envlist = py{27,34,36}-django{15,16}-{sqlite,mysql}

[testenv]
deps =
    py34-mysql: PyMySQL     # используйте, если и py34, и mysql находятся в имени env
    py27,py36: urllib3      # используйте, если в имени env есть py36 или py27
    py{27,36}-sqlite: mock  # имитация sqlite в Python 2.x и 3.6
    !py34-sqlite: mock      # имититация sqlite, кроме Python 3.4
    sqlite-!py34: mock      # (как в строке выше)
    !py34-!py36: enum34     # использовать, если в имени env нет ни py34, ни py36
```

Взгляните на первую линию **deps**. Она показывает, как можно выделить что-то для комбинации факторов, просто расставив их вместе через дефис. В этой конкретной строке указано, что **PyMySQL** будет загружен для сред `python 3.4`, `mysql`, например. `py34-django15-mysql` и `py34-django16-mysql`.

Вторая строка показывает, как вы используете одну и ту же настройку для нескольких факторов - перечисляя их через запятую. Можно перечислить не только простые факторы, но и их комбинации, например `py27-sqlite`, `py36-sqlite`.

Все остальные строки имеют тот же эффект и используют условия, эквивалентные `py27-sqlite`, `py36-sqlite`. Все они были добавлены только для демонстрации следующего:

* как факторные выражения расширяются так же, как в **envlist**
* как использовать отрицательные факторные условия, добавляя к отрицательным факторам префикс `!`
* что порядок, в котором факторы ставятся через дефис, не имеет значения

{% hint style="info" %}
Факторы не выполняют сопоставление подстроки с именем **env**, вместо этого каждое выражение с дефисом разделяется на **-** и если ВСЕ его неотрицательные факторы и НИ ОДИН из его отрицательных факторов также являются факторами **env**, то это условие считается выполненным для этого **env** .

Например, окружение **py36-mysql-!dev**:

* будет соответствовать выражениям **py36**, **py36-mysql** или **mysql-py36**,
* но НЕ **py2**, **py36-sql** или **py36-mysql-dev**.
{% endhint %}

### Факторы и замена значений совместимы

Можно смешивать как подстановку значений, так и факторные выражения. Например:

```bash
[tox]
envlist = py27,py36,coverage

[testenv]
deps =
    flake8
    coverage: coverage

[testenv:py27]
deps =
    {[testenv]deps}
    pytest
```

В предыдущей конфигурации он установит:

* Пакеты **flake8** и **pytest** для среды **py27**.
* Пакет **flake8** для среды **py36**.
* **flake8** и **coverage** пакеты для среды **coverage**.

## Расширенные настройки

### Обработка директивы интерпретатора с большой длиной

Для систем, поддерживающих исполняемые текстовые файлы (сценарии с shebang), система попытается проанализировать директиву интерпретатора, чтобы определить программу, которую следует выполнить в целевом текстовом файле. Когда **tox** подготавливает виртуальную среду в файловом контейнере большой длины (например, с использованием Jenkins Pipelines), система может быть не в состоянии вызывать сценарии shebang, которые определяют интерпретаторы за пределами системных ограничений (например, Linux как ограничение 128; **BINPRM\_BUF\_SIZE**). Чтобы обойти среду, которая страдает от ограничения директивы интерпретатора, пользователь может обойти синтаксический анализатор интерпретатора системы, определив переменную среды **TOX\_LIMITED\_SHEBANG** перед вызовом **tox**:

```bash
export TOX_LIMITED_SHEBANG=1
```

Когда обходной путь включен, все исполняемые файлы текстовых файлов, вызываемые **tox**, будут иметь свою директиву интерпретатора, анализируемую и явно выполняемую **tox**.

### Введенные переменные окружения

**tox** будет вводить следующие переменные среды, которые вы можете использовать для проверки того, что ваша команда выполняется в **tox**:

_Новое в версии 3.4_.

* **TOX\_WORK\_DIR** переменная среды устанавливает рабочий каталог **tox**
* **TOX\_ENV\_NAME** устанавливает текущее имя рабочей среды **tox**
* **TOX\_ENV\_DIR** устанавливает рабочий каталог текущей среды **tox**.
* **TOX\_PACKAGE** - конечный путь этапов упаковки (полезно для проверки и утверждения самого собранного пакета).
* **TOX\_PARALLEL\_ENV** устанавливается на имя текущей запущенной среды **tox**, только при работе в параллельном режиме.

{% hint style="info" %}
это применимо для всех **tox** **envs** (также изолированной упаковки) и всех вызываемых внешних команд (например, **install command - pip**).
{% endhint %}

### Прочие правила и примечания

спецификации **path**: если указанный **path** является относительным путем, он будет рассматриваться как относительный к **toxinidir**, каталогу, в котором находится файл конфигурации.

## CLI tox

### Параметры tox:

```bash
usage: tox [--version] [-h] [--help-ini] [-v] [-q] [--showconfig] [-l] [-a]
           [-c CONFIGFILE] [-e envlist] [--devenv ENVDIR] [--notest] [--sdistonly]
           [--skip-pkg-install] [-p [VAL]] [-o]
           [--parallel--safe-build] [--installpkg PATH] [--develop] [-i URL]
           [--pre] [-r] [--result-json PATH] [--discover PATH [PATH ...]]
           [--hashseed SEED] [--force-dep REQ]
           [--sitepackages] [--alwayscopy] [-s [val]] [--workdir PATH]
           [args [args ...]]
```

* &#x20;**args** - дополнительные аргументы, доступные для позиционной замены команд
* **--version** - сообщает информацию о версии на стандартный вывод.
* **-h, --help** - показать справку о настройках
* **--help-ini, --hi** - показать справку по ini-именам
* **-v, --verbose** - увеличивает подробность вывода отчетов. **-vv mode** отключает перенаправление вывода для установки пакета, выше уровня два флага подробности передаются в **pip** (с двумя уровнями меньше)
* **-q, --quiet** - вывод отчетов постепенно заглушается.
* **--showconfig** - показать живую конфигурацию (по умолчанию все **env**, с `-l` только цели по умолчанию, определенные через `TOXENV/-e`)
* **-l, --listenvs** - показать список тестовых сред (с подробным описанием)
* **-a, --listenvs-all** - показать список всех определенных сред (с подробным описанием)
* **-c** - имя файла **config** или каталог с файлом `tox.ini`.
* **-e** - работает с указанными средами (ALL выбирает все).
* **--devenv** - настраивает среду разработки в **ENVDIR** на основе конфигурации **tox** **env**, указанной параметром `-e` (`-e` по умолчанию - py).
* **--notest** - пропустить вызов тестовых команд.
* **--sdistonly** - выполнять только упаковку **sdist**.
* **--skip-pkg-install** - пропустить установку пакета для этого запуска
* **-p, --parallel** - запускать **tox** среды параллельно, аргумент контролирует ограничение: все, авто или отсутствующий аргумент - количество ЦП, некоторое положительное число, 0 для выключения
* **-o, --parallel-live** - подключиться к **stdout** во время работы сред
* **--parallel--safe-build** - (не рекомендуется) обеспечить параллельную работу двух сборок **tox** (используется файл блокировки в рабочем каталоге **tox** с расширением `.lock`)
* **--installpkg** - использовать указанный пакет для установки в **venv** вместо создания **sdist**.
* **--develop** - установить пакет в **venv**, используя «`setup.py develop`» через «`pip -e`».
* **-i, --index-url** - установить url-адрес сервера индекса (если URL-адрес имеет форму `name = url`, задайте URL-адрес для сервера индекса "**name**", в частности)
* **--pre** - установить предварительные релизы и разрабатываемые версии зависимостей. Это передаст параметр `–pre` команде **install\_command** (по умолчанию **pip**).
* **-r, --recreate** - принудительное воссоздание виртуальных сред
* **--result-json** - записать файл **json** с подробной информацией обо всех задействованных командах и результатах.
* **--discover** - для обнаружения python сначала попробуйте исполняемые файлы python по этим путям
* **--hashseed** - установите **PYTHONHASHSEED** на **SEED** перед запуском команд. По умолчанию используется случайное целое число в диапазоне `[1, 4294967295]` (`[1, 1024]` в Windows). Передача «**noset**» подавляет это поведение.
* **--force-dep** - Принудительно устанавливает определенную версию одной из зависимостей при настройке виртуальной среды. Примеры **REQ** `'pytest<2.7'` или `'pytest>=1.6'`.
* **--sitepackages** - переопределить настройку **sitepackages** на `True` во всех **envs**
* **--alwayscopy** - переопределить параметр **alwayscopy** для `True` во всех **envs**
* **-s, --skip-missing-interpreters** - не проваливайте тесты на отсутствие интерпретаторов: выбор `{config, true, false}`
* **--workdir** - рабочий каталог **tox**
